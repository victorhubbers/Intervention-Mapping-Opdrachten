var kInteractive={preRender:function(e,t){var n,a=(t=t||{}).singleElem,i=e||document;a?(n=[e],i=document):n=i.getElementsByClassName("kInteractive"),"undefined"!=typeof isKotobee&&(kInteractive.absoluteURL=t.chapterUrl?t.chapterUrl:angular.element(document.body).scope().data.book.chapter.absoluteURL);for(var r=n.length;r--;){var s=n[r];this.hasClass(s,"gallery")&&kInteractive.gallery.preRender(s,i,r),this.hasClass(s,"questions")&&kInteractive.questions.preRender(s,i,r),!this.hasClass(s,"image")&&"img"!=s.nodeName.toLowerCase()||kInteractive.image.preRender(s,i,r),this.hasClass(s,"link")&&kInteractive.link.preRender(s,i,r),this.hasClass(s,"container")&&kInteractive.container.preRender(s,i,r),this.hasClass(s,"equation")&&kInteractive.equation.preRender(s,i,r),this.hasClass(s,"lipsync")&&kInteractive.lipsync.preRender(s,i,r)}},postRender:function(t,e){var n=(e=e||{}).singleElem;"undefined"!=typeof isKotobee&&(kInteractive.absoluteURL=e.chapterUrl?e.chapterUrl:angular.element(document.body).scope().data.book.chapter.absoluteURL),kInteractive.videoIsFullscreen=!1,kInteractive.timestamp=new Date,kInteractive.currentVideo=kInteractive.currentAudio=null,kInteractive.clearAudioVideo(t);var a,i=t||document;n?(a=[t],i=document):a=i.getElementsByClassName("kInteractive");for(var r=a.length;r--;){var s=a[r],o=r;null!=e.forcedIndex&&(o=e.forcedIndex),this.hasClass(s,"container")?kInteractive.container.postRender(i,s,o,e):this.hasClass(s,"questions")?kInteractive.questions.postRender(i,s,o,e):this.hasClass(s,"widget")?kInteractive.widget.postRender(i,s,o,e):this.hasClass(s,"video")?kInteractive.video.postRender(i,s,o):this.hasClass(s,"audio")?kInteractive.audio.postRender(i,s,o):this.hasClass(s,"threed")?kInteractive.threed.postRender(i,s,o,e):this.hasClass(s,"gallery")?kInteractive.gallery.postRender(i,s,o):this.hasClass(s,"image")?kInteractive.image.postRender(i,s,o):this.hasClass(s,"equation")?kInteractive.equation.postRender(i,s,o):this.hasClass(s,"lipsync")&&kInteractive.lipsync.postRender(i,s,o)}this.firstRun&&(window.addEventListener("resize",function(e){kInteractive.resizeEvent(t,n)}),this.firstRun=!1),kInteractive.resizeEvent(t,n)},actionEvent:function(e){return kInteractive.action(e.target)},action:function(e,t){if(!kInteractive.isEditorMode()){"undefined"!=typeof isKotobee&&(kInteractive.absoluteURL=angular.element(document.body).scope().data.book.chapter.absoluteURL);for(var n=e;!this.hasClass(n,"kInteractive");){if(!n.parentNode)return;if((n=n.parentNode)==document.body)return}return this.hasClass(n,"questions")?kInteractive.questions.action(n,e):this.hasClass(n,"widget")?kInteractive.widget.action(n):this.hasClass(e,"link")?kInteractive.link.action(n,e):this.hasClass(e,"image")?kInteractive.image.action(n,e):this.hasClass(n,"gallery")?kInteractive.gallery.action(n,e):this.hasClass(n,"audio")?kInteractive.audio.action(n,e):this.hasClass(n,"video")?kInteractive.video.action(n,e):this.hasClass(n,"threed")?kInteractive.threed.action(n,e):this.hasClass(n,"equation")?kInteractive.equation.action(n,e):this.hasClass(n,"lipsync")?kInteractive.lipsync.action(n,e):void 0}},trigger:function(e,t){this.action(t,e)},resize:function(e,t){kInteractive.resizeEvent(e,t)},resizeEvent:function(e,t){var n=e||document;t&&(n=document);for(var a=n.getElementsByClassName("kInteractive"),i=a.length;i--;){var r=a[i];this.hasClass(r,"image")?kInteractive.image.resize(r):this.hasClass(r,"gallery")?kInteractive.gallery.resize(r):this.hasClass(r,"container")?kInteractive.container.resize(r):this.hasClass(r,"video")?kInteractive.video.resize(r):this.hasClass(r,"widget")?kInteractive.widget.resize(r):this.hasClass(r,"equation")&&kInteractive.equation.resize(r)}},helpers:{},vQueue:[],youTubeReady:!1,firstRun:!0};if("undefined"==typeof isKotobee){kotobee={};var kotobeeListeners=[];function getKotobeeListener(e){if(e)for(var t=kotobeeListeners.length;t--;)if(kotobeeListeners[t].event==e)return kotobeeListeners[t]}function clearKotobeeListeners(e){for(var t=kotobeeListeners.length;t--;)e&&kotobeeListeners[t].event!=e||kotobeeListeners.splice(t,1)}function dispatchKotobeeEvent(){}function kInteractionStart(){this.log=function(e){},kInteractive.setDOMParser(),kInteractive.preRender(),kInteractive.postRender()}function kInteractionStartSingleElem(e,t){kInteractive.setDOMParser(),kInteractive.preRender(e,{singleElem:!0}),kInteractive.postRender(e,{singleElem:!0,forcedIndex:t})}function renderMathJax(){MathJax&&MathJax.typeset&&MathJax.typeset()}document.addEventListener("DOMContentLoaded",function(e){"undefined"!=typeof kotobeeReady&&kotobeeReady(e),document.dispatchEvent(new Event("kotobeeReady")),document.dispatchEvent(new Event("kotobeeChapterLoaded")),kotobee.dispatchEvent("ready"),kotobee.dispatchEvent("chapterLoaded"),document.addEventListener("scroll",function(e){kotobee.dispatchEvent("scrolled",e)})}),kotobee.addEventListener=function(){if(!(arguments.length<2)){var e,t=arguments[0],n={};e=2==arguments.length?arguments[1]:(n=arguments[1],arguments[2]),n.unique&&clearKotobeeListeners(t);var a={event:t,cb:e};kotobeeListeners.push(a)}},kotobee.dispatchEvent=function(e,t){if(e){var n=getKotobeeListener(e);n&&n.cb&&n.cb.apply(this,[t])}};try{document.addEventListener("DOMContentLoaded",kInteractionStart,!1)}catch(e){window.addEventListener("load",kInteractionStart,!1)}}kInteractive.audio={preRender:function(e,t){},postRender:function(e,t,n){var a=e.createDocumentFragment(),i=kInteractive.readData(t);t.setAttribute("id","ki-audio-"+n),t.innerHTML="";var r=document.createElement("div");r.setAttribute("id","ki-audio-"+n+"-container"),r.className="container";var s=document.createElement("a");s.className="playBtn ki-btn",s.appendChild(document.createElement("span")),"undefined"==typeof isKotobee&&s.addEventListener("click",kInteractive.actionEvent);var o=document.createElement("div");if(i.style&&kInteractive.c.addClass(o,i.style),a.appendChild(s),a.appendChild(r),o.appendChild(a),t.appendChild(o),i.autoplay)kInteractive.action(t)},action:function(e){kInteractive.stopCurrentMedia();var t=kInteractive.readData(e);if(t){t.audioType||(t.audioType=t.type);e.getAttribute("id");e.getElementsByClassName("playBtn")[0].className="playBtn ki-btn hide";var n=t.src;if("file"==t.audioType&&(n="undefined"==typeof isKotobee?t.audio:t.relToRoot?ph.join(bookPath,t.audio):ph.join(kInteractive.absoluteURL,t.audio)),kInteractive.scorm){var a={};a.id=kInteractive.getScormId(e.getAttribute("id"),n),a.description="Played audio: "+n,a.type="other",a.learnerResponses="Played",a.objective=t.options?t.options.objective:null,a.timestamp=new Date,kInteractive.scorm.setInteractions([a])}kInteractive.events&&kInteractive.events.add({action:"audioPlayed",param:n,elem:e,data:t});var i=document.createElement("audio");i.setAttribute("controls","true"),i.setAttribute("autoplay","true"),i.setAttribute("data-tap-disabled","false");var r=document.createElement("source");r.src=kInteractive.cleanURL(n),i.appendChild(r),i.appendChild(document.createTextNode("Your browser does not support the audio element")),i.className="ki-noHighlight",i.oncanplay=function(){kInteractive.currentAudio==e&&kInteractive.tinCan({verb:"played",activity:"Audio: "+n})},e.getElementsByClassName("container")[0].appendChild(i),i.play(),kInteractive.currentAudio=e,kInteractive.c.addClass(kInteractive.currentAudio,"playing")}}};var log=console.log,kInteractiveCommon={checkResponsiveFloat:function(e,t){if(e&&e.disableWrapForMobile&&"none"!=e.float){var n=t.parentNode;t.offsetWidth>.6*n.offsetWidth&&.4*(n.offsetWidth-t.offsetWidth)<100?kInteractive.c.addClass(t,"fullRow"):kInteractive.c.removeClass(t,"fullRow")}},openFrame:function(u){var v=document.getElementById("kInteractiveFrame"),p=document.getElementById("kiDarkOverlay"),m="";if(u.dict||(u.dict={}),u.width&&(m+="width:"+u.width+"px;max-width:"+u.width+"px;"),u.height&&(m+="height:"+u.height+"px;max-height:"+u.height+"px;"),v||((p=document.createElement("div")).id="kiDarkOverlay",document.body.appendChild(p),p.style.display="none",p.style.position="fixed",p.addEventListener("click",kInteractive.closeFrame),(v=document.createElement("div")).id="kInteractiveFrame"),u.pos||(u.pos="top"),"none"!=u.pos){var e=document.createElement("a"),t="closeBtn";u.pos&&(t+=" "+u.pos),e.className=t;var n=u.dict.close?u.dict.close:"Close";try{n=angular.element(document.body).scope().translit("close")}catch(e){}"side"!=u.pos&&(e.innerHTML=n),e.addEventListener("click",kInteractive.closeFrame),v.appendChild(e)}var h=u.class?u.class:"";(u.width||u.height)&&(h+=" fixed"),u.aspectRatio&&(h+=" aspectRatio"),v.style.display="block",v.className=h,document.body.appendChild(v),kInteractive.frameIsOpen=!0,kInteractive.frameOb=u;try{if("undefined"!=typeof isKotobee&&!native){var a=window.location.hash.split("#");1<a.length&&(window.location.hash+=(-1==a[1].indexOf("?")?"?":"&")+"popup",window.addEventListener("hashchange",this.backBtnPressed))}}catch(e){}function i(){p.style.display="block",p.className="show";var e=window.innerHeight||document.documentElement.clientHeight||document.getElementsByTagName("body")[0].clientHeight,t=window.innerWidth||document.documentElement.clientWidth||document.getElementsByTagName("body")[0].clientWidth;e-=20,t-=20;var n=1;if(u.width&&u.height){var a=t/u.width,i=e/u.height;1<(n=a<i?a:i)&&(n=1)}var r="display:block;";r+=m;var s=u.width||u.height?"-50%,-50%":"0%,0%";r+="-webkit-transform:translate("+s+") scale("+n+");-moz-transform:translate("+s+") scale("+n+");transform:translate("+s+") scale("+n+");",r+="position:fixed;","undefined"==typeof isKotobee&&"-50%,-50%"==s&&(r+="top:"+Math.round(window.innerHeight/2)+"px;",r+="left:"+Math.round(window.innerWidth/2)+"px;"),-1!=h.indexOf("aspectRatio")&&window.innerWidth/window.innerHeight>16/9&&(r+="padding-bottom: "+95*window.innerHeight/Math.round(window.innerWidth)+"%"),v.style.cssText=r,v.className=h+" ready";var o=v.getElementsByClassName("closeBtn");if(o.length){var c=o[0],l=1/n,d="-50%";kInteractive.hasClass(c,"side")&&(d="0%"),c.style.cssText="-webkit-transform: translate("+d+",0%) scale("+l+");-webkit-transform-origin: 50% 50%;-moz-transform: translate("+d+",0%) scale("+l+");-moz-transform-origin: 50% 50%;transform: translate("+d+",0%) scale("+l+");transform-origin: 50% 50%;"}}kInteractive.openFrame.resized=i,window.addEventListener("resize",i),setTimeout(function(){i(),u.cb&&u.cb(v)},100)},closeAlert:function(e){e&&e.stopPropagation();var t=document.getElementById("kiSystemAlertBox"),n=document.getElementById("kiSystemAlertBackdrop");t.parentNode.removeChild(t),n.parentNode.removeChild(n),kInteractive.alertIsOpen=!1,window.removeEventListener("resize",kInteractive.alert.resized),kInteractive.alert.resized=null},backBtnPressed:function(e){e.oldURL&&e.oldURL.match(/[?&]popup/g)&&(window.removeEventListener("hashchange",kInteractive.backBtnPressed),kInteractive.closeFrame())},closeFrame:function(){var e=document.getElementById("kInteractiveFrame"),t=document.getElementById("kiDarkOverlay");kInteractive.frameIsOpen=!1,window.removeEventListener("resize",kInteractive.openFrame.resized),kInteractive.openFrame.resized=null,kInteractive.c.removeClass(e,"ready");var n=kInteractive.frameOb,a="";n.width&&(a+="width:"+n.width+"px;max-width:"+n.width+"px;"),n.height&&(a+="height:"+n.height+"px;max-height:"+n.height+"px;"),e.style.cssText=a,t.className="",setTimeout(function(){e.innerHTML="",e.style.display=t.style.display="none",n.closed&&n.closed(),kInteractive.frameOb=null},300),window.removeEventListener("hashchange",kInteractive.closeFrame),window.location.hash=window.location.hash.replace(/[?&]popup/g,"")},stopCurrentMedia:function(){if(kInteractive.currentVideo){var e=kInteractive.currentVideo.getAttribute("id")+"-container";if(n=document.getElementById(e)){var t=n.parentNode;n.parentNode.removeChild(n),(a=document.createElement("div")).setAttribute("id",e),a.className="container",(i=kInteractive.currentVideo.getElementsByClassName("playBtn")[0]).className="playBtn ki-btn",kInteractive.c.removeClass(kInteractive.currentVideo,"playing"),t.appendChild(a)}}var n;if(kInteractive.currentAudio)if(e=kInteractive.currentAudio.getAttribute("id")){if(e+="-container",n=document.getElementById(e)){var a,i;t=n.parentNode;n.parentNode.removeChild(n),(a=document.createElement("div")).setAttribute("id",e),a.className="container playerContainer",(i=kInteractive.currentAudio.getElementsByClassName("playBtn")[0])&&(i.className="playBtn ki-btn"),kInteractive.c.removeClass(kInteractive.currentAudio,"playing"),t.appendChild(a)}}else try{var r=kInteractive.currentAudio.getElementsByTagName("audio");r.length&&(r[0].pause(),r[0].src=""),kInteractive.currentAudio.pause&&(kInteractive.currentAudio.pause(),kInteractive.currentAudio.src="");for(var s=document.getElementsByClassName("kiAudioLoader"),o=s.length;o--;)s[o].parentNode.removeChild(s[o])}catch(e){}},hasClass:function(e,t){if(e&&e.className)for(var n=e.className.trim().split(" "),a=0;a<n.length;a++)if(n[a]&&n[a].trim()==t)return!0},appendAfterDelay:function(e,t){setTimeout(function(){e.appendChild(t)},30)},replaceHTML:function(e,t){var n="string"==typeof e?document.getElementById(e):e,a=n.cloneNode(!1);return a.innerHTML=t,n.parentNode.replaceChild(a,n),a},tinCan:function(e){if("undefined"!=typeof isKotobee)try{angular.element(document.body).scope().tinCanShortcut(e)}catch(e){}},setDOMParser:function(){!function(e){"use strict";var t=e.prototype,r=t.parseFromString;try{if((new e).parseFromString("","text/html"))return}catch(e){}t.parseFromString=function(e,t){if(/^\s*text\/html\s*(?:;|$)/i.test(t)){var n,a=document.implementation.createHTMLDocument(""),i=a.documentElement;return i.innerHTML=e,n=i.firstElementChild,1===i.childElementCount&&"html"===n.localName.toLowerCase()&&a.replaceChild(n,i),a}return r.apply(this,arguments)}}(DOMParser)},compareVersions:function(e,t){if(e==t)return 0;if(null==e)return 1;if(null==t)return-1;var n=e.split("."),a=t.split(".");return a.length?n.length?Number(n[0])>Number(a[0])?1:Number(a[0])>Number(n[0])?-1:(n.shift(1),a.shift(1),kInteractive.compareVersions(n.join("."),a.join("."))):-1:1},readData:function(e){try{var t=e.getAttribute("data-kotobee");t=t||e.getAttribute("data");var n=1;if(!t)return;return JSON.parse(decodeURI(kInteractive.XORCipher(n).decode("kotobee%%author",t)))}catch(e){try{return JSON.parse(kInteractive.XORCipher(n).decode("kotobee%%author",t))}catch(e){}}},writeData:function(e,t,n){n=n||1;var a=encodeURI(JSON.stringify(t)),i=e.hasAttribute("data-kotobee")?"data-kotobee":"data";e.setAttribute(i,kInteractive.XORCipher(n).encode("kotobee%%author",a))},XORCipher:function(e){var u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(e,t){return function(e){var t,n,a,i,r,s,o,c,l=0,d="";if(!e)return e;for(;t=e[l++],n=e[l++],a=e[l++],i=(o=t<<16|n<<8|a)>>12&63,r=o>>6&63,s=63&o,d+=u.charAt(o>>18&63)+u.charAt(i)+u.charAt(r)+u.charAt(s),l<e.length;);return((c=e.length%3)?d.slice(0,c-3):d)+"===".slice(c||3)}(t=function(n,e){return i(e,function(e,t){return e.charCodeAt(0)^a(n,t)})}(e,t))},decode:function(e,t){return function(n,e){return i(e,function(e,t){return String.fromCharCode(e^a(n,t))}).join("")}(e,t=function(e){var t,n,a,i,r,s,o,c,l=0,d=[];if(!e)return e;e+="";for(;i=u.indexOf(e.charAt(l++)),r=u.indexOf(e.charAt(l++)),s=u.indexOf(e.charAt(l++)),o=u.indexOf(e.charAt(l++)),t=(c=i<<18|r<<12|s<<6|o)>>16&255,n=c>>8&255,a=255&c,d.push(t),64!==s&&(d.push(n),64!==o&&d.push(a)),l<e.length;);return d}(t))}};function a(e,t){return e.charCodeAt(Math.floor(t%e.length))}function i(e,t){for(var n=[],a=0;a<e.length;a++)n[a]=t(e[a],a);return n}},getScormId:function(e,t){return e+(t=t?"-"+t.replace(/[^a-zA-Z0-9]/g,"-").substr(0,80):"")},confirm:function(e){kInteractive.alert(e)},alert:function(e){if(e){var t=document.createElement("div");if(t.setAttribute("id","kiSystemAlertBox"),e.raw&&(t.className="raw"),t.style.position="fixed","undefined"==typeof isKotobee&&(t.style.top=Math.round(window.innerHeight/2)+"px",t.style.left=Math.round(window.innerWidth/2)+"px"),e.raw)t.innerHTML=e.content.replace("&nbsp;","&#160;");else{var n=document.createElement("div");n.innerHTML=e.content.replace("&nbsp;","&#160;"),n.className="content",t.appendChild(n)}if(e.title){var a=document.createElement("div");a.innerHTML=e.title.replace("&nbsp;","&#160;"),a.className="header",t.insertBefore(a,t.firstChild)}kInteractive.alertIsOpen=!0;var i=document.createElement("a");if(!e.raw){var r=document.createElement("div");r.className="footer";var s="OK";try{s=angular.element(document.body).scope().translit("ok")}catch(e){}if(e.okBtn&&(s=e.okBtn),i.innerHTML=s.replace("&nbsp;","&#160;"),i.className="okBtn",i.addEventListener("click",kInteractive.closeAlert),e.cb&&i.addEventListener("click",e.cb),r.appendChild(i),e.noBtn){var o=document.createElement("a");o.innerHTML=e.noBtn,o.className="cancelBtn",o.addEventListener("click",kInteractive.closeAlert),r.appendChild(o)}t.appendChild(r)}var c=document.createElement("div");e.noBackdrop||(c.setAttribute("id","kiSystemAlertBackdrop"),c.addEventListener("click",kInteractive.closeAlert),c.style.position="fixed",document.body.appendChild(c)),document.body.appendChild(t),i.focus(),kInteractive.alert.resized=l,window.addEventListener("resize",l),setTimeout(function(){kInteractive.c.addClass(t,"show"),kInteractive.c.addClass(c,"show")},50)}function l(){"undefined"==typeof isKotobee&&(t.style.top=Math.round(window.innerHeight/2)+"px",t.style.left=Math.round(window.innerWidth/2)+"px")}},c:{addClass:function(e,t){var n=e.className.trim();if(t instanceof Array){for(var a=!0,i=0;i<t.length;i++)-1==n.indexOf(t[i])&&(a=!1,n+=(""==n?"":" ")+t[i]);if(a)return}else{if(0<=n.indexOf(t))return;n+=(""==n?"":" ")+t}e.className=n},toggleClass:function(e,t){this.strHasClass(e.className,t)?this.removeClass(e,t):this.addClass(e,t)},hasClass:function(e,t){return this.strHasClass(e.className,t)},strHasClass:function(e,t){for(var n=(e=e||"").trim().split(" "),a=0;a<n.length;a++)if(n[a]==t)return!0;return!1},removeClass:function(e,t){var n=e.className;if(t instanceof Array){for(var a=!0,i=0;i<t.length;i++)0<=n.indexOf(t[i])&&(a=!1,n=n.replace(t[i],""));if(a)return}else{if(-1==n.indexOf(t))return;n=(n=n.replace(t,"")).replace(/ {2,}?/g," ")}""==(n=n.trim())?e.removeAttribute("class"):e.className=n},removeHash:function(e){return-1==e.indexOf("#")?e:e.substring(0,e.lastIndexOf("#"))},removeFilename:function(e){var t=kInteractive.c.normalizedArray(e);return-1==t[t.length-1].indexOf(".")?e:(t.splice(t.length-1,1),t.join("/"))},normalizedArray:function(e){for(var t=(e=e.replace(/\\/g,"/")).split("/"),n=t.length;n--;)t[n]?".."==t[n]&&0<n&&".."!=t[n-1]&&(t.splice(n,1),t.splice(n-1,1)):t.splice(n,1);return t[0].match(/http[s]?:$/g)&&(t[0]+="//"+t[1],t.splice(1,1)),t[0].match(/kotobee:$/g)&&(t[0]+="//"+t[1],t.splice(1,1)),"file:"==t[0]&&(t[0]+="///"+t[1],t.splice(1,1)),t}},shuffleArray:function(e){e.sort(function(){return Math.random()-.5})},allowDrop:function(e){e.preventDefault()},drag:function(e){e.dataTransfer&&e.dataTransfer.setData("text",e.target.id),dragged=e.target},drop:function(e){e.preventDefault(),e.target.hasAttribute("ondragover")&&e.target.appendChild(e.view.dragged)},escapeHtml:function(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,function(e){return t[e]})},getChildIndex:function(e){for(var t=0;null!=(e=e.previousSibling);)t++;return t},isAbsolutePath:function(e){if(e)return 0==e.trim().indexOf("http://")||(0==e.trim().indexOf("https://")||(0==e.trim().indexOf("//")||(0==e.trim().indexOf("data:")||(!!/.\:[\\\/].*/g.test(e.trim())||void 0))))},isMobile:function(e){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent))return!0;try{if(0<window.location.href.indexOf("?preview")){var t=window.location.href.split("?");t=t[1].split("&");for(var n={},a=0;a<t.length;a++){var i=t[a].split("=");n[i[0]]=i[1]}if(n.mobile)return!0}}catch(e){}},getChildIndex:function(e){for(var t=0;null!=(e=e.previousSibling);)t++;return t},closeFullscreenVideo:function(){kInteractive.currentVideo&&(kInteractive.currentVideo.webkitExitFullscreen?kInteractive.currentVideo.webkitExitFullscreen():kInteractive.currentVideo.mozCancelFullScreen?kInteractive.currentVideo.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen&&document.mozCancelFullScreen(),kInteractive.videoIsFullscreen=!1)},getWidgetHome:function(e,t){return{},e.path?"undefined"==typeof isKotobee?e.path:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,e.path):"undefined"==typeof isKotobee?"../js/widgets/":bookPath+"EPUB/js/widgets/"},getWidgetUrl:function(e,t){var n=kInteractive.getWidgetHome(e,t)+"/"+e.name+"/"+e.src;if("undefined"!=typeof isKotobee){var a=angular.element(document.body).scope().data.user;a&&a.email&&a.signatures&&a.signatures.bookwidgets&&e.id&&0==e.id.indexOf("com.kidimedia")&&(n+="?oauth_signature="+a.signatures.bookwidgets.signature,n+="&oauth_nonce="+a.signatures.bookwidgets.nonce,n+="&oauth_timestamp="+a.signatures.bookwidgets.timestamp,n+="&oauth_consumer_key="+a.signatures.bookwidgets.key,n+="&lti_version=LTI-1p0",n+="&oauth_signature_method=HMAC-SHA1",n+="&oauth_version=1.0",n+="&tool_consumer_info_product_family_code=kotobee",n+="&lis_person_contact_email_primary="+a.email,n+="&lis_person_name_full="+(a.name?a.name:""),n+="&user_id="+a.id,n+="&lti_message_type=basic-lti-launch-request",angular.element(document.body).scope().refreshSignatures&&angular.element(document.body).scope().refreshSignatures())}return n=kInteractive.cleanURL(n)},clearAudioVideo:function(e){var t=e||document;kInteractive.stopCurrentMedia();for(var n=t.getElementsByTagName("audio"),a=n.length;a--;)try{if(n[a].hasAttribute("data-dontclose"))continue;n[a].pause(),n[a].children.length||(n[a].src="")}catch(e){}var i=t.getElementsByTagName("video");for(a=i.length;a--;)i[a].pause(),i[a].children.length||(i[a].src="")},cleanURL:function(e){try{native&&mobile&&(e=window.Ionic.WebView.convertFileSrc(e))}catch(e){}return e},listenForSwiping:function(s){s.addEventListener("touchstart",function(e){o=e.touches[0].clientX,c=e.touches[0].clientY},!1),s.addEventListener("touchmove",function(e){if(null===o)return;if(null===c)return;var t=e.touches[0].clientX,n=e.touches[0].clientY,a=o-t,i=c-n;5<a?(s.dispatchEvent(new Event("swipeleft")),r()):a<-5?(s.dispatchEvent(new Event("swiperight")),r()):5<i?(s.dispatchEvent(new Event("swipeup")),r()):i<-5&&(s.dispatchEvent(new Event("swipedown")),r());function r(){c=o=null}e.preventDefault()},!1);var o=null,c=null},unique:function(e){return e.filter(function(e,t,n){return n.indexOf(e)===t})},getBookID:function(){var e=document.head.querySelector('meta[name="kotobee-book"]');return"undefined"!=typeof isKotobee&&kotobee.book?kotobee.book.meta.dc.identifier.replace("urn:uuid:","")+(kotobee.user&&kotobee.user.email?kotobee.user.email:""):e?e.content.replace("urn:uuid:",""):""},getChapterID:function(){var e;if("undefined"!=typeof isKotobee)e=kotobee.currentChapter?kotobee.currentChapter.url:"/ch1.xhtml";else{var t=document.head.querySelector('meta[name="kotobee-chapter"]');e=t?t.content:""}return e.substring(e.lastIndexOf("/")+1).replace(".xhtml","")},setStorage:function(e){kInteractive.storage=e||sessionStorage},getLocalData:function(t,e){var n=t.label||t.category;if(t)if(e)if(n){var a=kInteractive.storage.getItem("ebook-"+kInteractive.getBookID())||"[]";e(a=(a=JSON.parse(a)).filter(function(e){return t.label?t.category?t.subcategory?e.label==t.label&&e.category==t.category&&e.subcategory==t.subcategory:e.label==t.label&&e.category==t.category:e.label==t.label:t.subcategory?e.category==t.category&&e.subcategory==t.subcategory:e.category==t.category}))}else e({error:"invalid label or category!"});else;else;},getLocalDataArray:function(e,t){if(Array.isArray(e))if(t){var n=kInteractive.storage.getItem("ebook-"+kInteractive.getBookID())||"[]";n=JSON.parse(n);var a=[];e.forEach(function(t){(t.label||t.category)&&a.push({results:n.filter(function(e){return t.label?t.category?t.subcategory?e.label==t.label&&e.category==t.category&&e.subcategory==t.subcategory:e.label==t.label&&e.category==t.category:e.label==t.label:t.subcategory?e.category==t.category&&e.subcategory==t.subcategory:e.category==t.category})})}),t(a.length?a:n)}else;else t([{error:"invalid array!"}])},setLocalData:function(t,e){if(t)if(e)if(t.label)if(t.data){var n={label:t.label,data:t.data,date:(new Date).toUTCString()};t.category&&(n.category=t.category),t.subcategory&&(n.subcategory=t.subcategory);var a=kInteractive.storage.getItem("ebook-"+kInteractive.getBookID())||"[]";if(a=JSON.parse(a),t.overwrite){var i=a.findIndex(function(e){return t.category?t.subcategory?e.label==t.label&&e.category==t.category&&e.subcategory==t.subcategory:e.label==t.label&&e.category==t.category:e.label==t.label});-1!=i?a.splice(i,1,n):a.push(n)}else a.push(n);kInteractive.storage.setItem("ebook-"+kInteractive.getBookID(),JSON.stringify(a)),e({success:"added"})}else e({error:"invalid data!"});else e({error:"invalid label!"});else;else;},setLocalDataArray:function(e,t){if(Array.isArray(e))if(t){var a=kInteractive.storage.getItem("ebook-"+kInteractive.getBookID())||"[]";a=JSON.parse(a);var i={};e.forEach(function(t){if(t.label){if(!i.hasOwnProperty("error")){var e={label:t.label,data:t.data,date:(new Date).toUTCString()};if(t.category&&(e.category=t.category),t.subcategory&&(e.subcategory=t.subcategory),t.overwrite){var n=a.findIndex(function(e){return t.category?t.subcategory?e.label==t.label&&e.category==t.category&&e.subcategory==t.subcategory:e.label==t.label&&e.category==t.category:e.label==t.label});-1!=n?a.splice(n,1,e):a.push(e)}else a.push(e)}}else i.error="invalid label!"}),i.hasOwnProperty("error")||(i.success="added"),kInteractive.storage.setItem("ebook-"+kInteractive.getBookID(),JSON.stringify(a)),t(i)}else;else t([{error:"invalid array!"}])},deleteLocalData:function(t,e){if(t)if(e)if(t.label){var n=kInteractive.storage.getItem("ebook-"+kInteractive.getBookID())||"[]",a=(n=JSON.parse(n)).findIndex(function(e){return t.category?t.subcategory?e.label==t.label&&e.category==t.category&&e.subcategory==t.subcategory:e.label==t.label&&e.category==t.category:e.label==t.label});-1!=a&&n.splice(a,1),kInteractive.storage.setItem("ebook-"+kInteractive.getBookID(),JSON.stringify(n)),e({success:!0})}else e({error:"invalid label!"});else;else;},deleteLocalDataArray:function(e,t){if(Array.isArray(e))if(t){var n=kInteractive.storage.getItem("ebook-"+kInteractive.getBookID())||"[]";n=JSON.parse(n);var a={};e.forEach(function(t){if(t.label){if(!a.hasOwnProperty("error")){var e=n.findIndex(function(e){return t.category?t.subcategory?e.label==t.label&&e.category==t.category&&e.subcategory==t.subcategory:e.label==t.label&&e.category==t.category:e.label==t.label});-1!=e&&n.splice(e,1)}}else a.error="invalid label!"}),a.hasOwnProperty("error")||(a.success=!0),kInteractive.storage.setItem("ebook-"+kInteractive.getBookID(),JSON.stringify(n)),t(a)}else;else t([{error:"invalid array!"}])},clearLocalData:function(){kInteractive.storage?kInteractive.storage.removeItem("ebook-"+kInteractive.getBookID()):kInteractive.error("unable to find storage!")},isEditorMode:function(){return"undefined"!=typeof editorMode&&editorMode}};for(var item in kInteractiveCommon)kInteractive[item]=kInteractiveCommon[item];function kPersister(e){this.enabled=!0,this.delegateEvents=!0,this.storage="cloud",this.root=document.body,this.interval=200,this.book="",this.chapter="",this.data=[],this.text=[],this.number=[],this.radio=[],this.checkbox=[],this.textarea=[],this.dragdrop=[],this.callback=null,this.silentMode=!1,this.forceNotification=!1,this.saveGlobal=!1,this.isSaveGlobal=!1,this.listener=null,this.testMode=!1,this.enableUncheckRadio=!1,this.setRadioGroup=!0,this.messages={save:"Save",unsaved:"You have unsaved changes",saving:"Saving your responses ..",saved:"Changes has been saved!",dismiss:"dismiss",lastSaved:"Last saved on"},this.design={placement:"bottom-right",unsaved:{color:"#fff",background:"#de7a7a"},success:{color:"#fff",background:"#14c39a"}},this.enable=function(e){this.enabled=!0,this.silentMode=e,this.renderInlineBar(),this.renderFloatingBar()},this.disable=function(){this.enabled=!1,u(".unsaved-changes-"+n.root.id)&&u(".unsaved-changes-"+n.root.id).classList.remove("show")},this.setOptions=function(e){var t=this;for(var n in e)"messages"==n?t.setMessages(e.messages):"design"==n?t.setDesign(e.design):t.hasOwnProperty(n)&&(t[n]=e[n],"root"==n&&(t[n].id=e[n].id||"_"+Math.random().toString(36).substr(2,9)))},this.setDesign=function(e){for(var t in e)this.design.hasOwnProperty(t)?(-1!=["placement"].indexOf(t)||e[t].color||e[t].background)&&(this.design[t]=e[t]):v("error",["invalid design state:",t])},this.setMessages=function(e){var t=this;for(var n in e)if(t.messages.hasOwnProperty(n)){if(t.messages[n]=e[n],u(".unsaved-changes-"+t.root.id)&&!kInteractive.isEditorMode()&&u(".unsaved-changes-"+t.root.id+" ."+n))if("button"==u(".unsaved-changes-"+t.root.id+" ."+n).nodeName.toLowerCase())try{u(".unsaved-changes-"+t.root.id+" ."+n).innerText=e[n]}catch(e){}else try{u(".unsaved-changes-"+t.root.id+" ."+n+" span").innerText=e[n]}catch(e){}}else v("error",["invalid message key:",n])},this.waitFor=function(e,t,n){var a=this;n=n||0,window[e]||0==e.indexOf("#")&&"undefined"!=typeof document&&document.querySelector(e)||0==e.indexOf(".")&&"undefined"!=typeof document&&document.querySelector(e)||"document.body"==e&&"undefined"!=typeof document&&document.body?t():n<3e3?setTimeout(function(){a.waitFor(e,t,n+100)},100):(v("error",["unable to find:",e]),t&&t())},this.renderInlineBar=function(){var e=this;if(u(".persist-log-"+e.root.id)&&u(".persist-log-"+e.root.id).parentNode.removeChild(u(".persist-log-"+e.root.id)),e.silentMode&&!kInteractive.isEditorMode()){var t=e.getRootSelector();u(t)?u(t).insertAdjacentHTML("beforeend",'<div class="persist-log persist-log-'+e.root.id+'"><span class="saving" style="display:none;color:'+e.design.unsaved.background+'">'+e.messages.saving+'</span><span class="success" style="display:none;color:'+e.design.success.background+'">'+e.messages.lastSaved.trim()+" "+(new Date).toLocaleDateString()+'</span><span class="error" style="display:none"></span></div>'):v("warn",["unable to find root selector:",t])}},this.renderFloatingBar=function(){var e=this;if(u(".unsaved-changes-"+e.root.id)&&u(".unsaved-changes-"+e.root.id).parentNode.removeChild(u(".unsaved-changes-"+e.root.id)),!e.silentMode&&!kInteractive.isEditorMode()){var t="",n="",a="",i=e.design.placement.split("-");if(i.length&&(a+=i[0]+":70px;"),1<i.length)switch(a+=i[1]+":0px;",i[1]){case"left":t="-",n="";break;case"right":t="",n="-";break;default:v("error",["invalid horizontal placement:",i[1]])}var r="#fff",s="#333";if("undefined"!=typeof kotobee){var o=document.querySelectorAll("#kotobee .tabs");o.length&&(r=getComputedStyle(o[0]).backgroundColor,s=getComputedStyle(o[0]).color)}var c='<style id="'+e.root.id+'-persister-styles">.unsaved-changes-'+e.root.id+"{"+a+";display:none;transform:translateX("+t+"100%);background:"+r+";color:"+s+"}.unsaved-changes-"+e.root.id+".show{display:block;transform: translateX("+n+"20px)}.unsaved-changes-"+e.root.id+" button{background-color:"+e.design.unsaved.background+";color:"+e.design.unsaved.color+"}.unsaved-changes-"+e.root.id+".success button{background-color:"+e.design.success.background+";color:"+e.design.success.color+"</style>";document.head.querySelector("#"+e.root.id+"-persister-styles")||document.head.insertAdjacentHTML("beforeend",c);var l=u(".perspectiveContainer")?u(".perspectiveContainer"):document.body;if(l){var d='<div class="unsaved-changes unsaved-changes-'+e.root.id+'"><div class="unsaved"><span>'+e.messages.unsaved+'</span> <button class="dismiss">'+e.messages.dismiss+'</button> <button class="save-now">'+e.messages.save+'</button></div><div class="saving" style="display:none;"><svg width="20px" height="20px" style="background:none;float:left;margin-top:5px;margin-right:5px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" class="lds-rolling"><circle cx="50" cy="50" fill="none" stroke="#ffffff" stroke-width="10" r="35" stroke-dasharray="164.93361431346415 56.97787143782138" transform="rotate(149.879 50 50)"><animateTransform attributeName="transform" type="rotate" calcMode="linear" values="0 50 50;360 50 50" keyTimes="0;1" dur="1s" begin="0s" repeatCount="indefinite"></animateTransform></circle></svg><span>'+e.messages.saving+'</span></div><div class="saved" style="display:none;"><span>'+e.messages.saved+'</span> <button class="dismiss">'+e.messages.dismiss+'</button></div><div class="notsaved" style="display:none;"><span></span> <button class="dismiss">'+e.messages.dismiss+"</button></div></div>";try{l.insertAdjacentHTML("afterbegin",d),e.waitFor(".unsaved-changes-"+e.root.id,function(){u(".unsaved-changes-"+e.root.id+" .dismiss",!0)?u(".unsaved-changes-"+e.root.id+" .dismiss",!0).forEach(function(e){e.addEventListener("click",function(e){u(e.currentTarget).parents(".unsaved-changes").classList.remove("show")})}):v("error",["unable to find dismiss button!"]),u(".unsaved-changes-"+e.root.id+" .save-now")?u(".unsaved-changes-"+e.root.id+" .save-now").addEventListener("click",function(){e.save()}):v("error",["unable to find save button!"])})}catch(e){v("error",[e,d])}}else v("error",["unable to find suitable container!"])}},this.getRootSelector=function(){return n.root.id?"#"+n.root.id:"."+n.root.className.splice(" ").join(".")},this.setNotify=function(e){var t=this;t.enabled&&u(".unsaved-changes-"+t.root.id)&&!kInteractive.isEditorMode()&&(e&&e.constructor===Object&&0<Object.keys(e).length&&t.setOptions(e),u(".unsaved-changes-"+t.root.id).classList.contains("show")&&!u(".unsaved-changes-"+t.root.id).classList.contains("success")||t.updateNotification("reset"))},this.save=function(e){var t=this;if(t.enabled){t.collectInputs(),t.updateNotification("saving");var n=[];t.text&&t.text.forEach(function(e){e.id&&n.push(e)}),t.number&&t.number.forEach(function(e){e.id&&n.push(e)}),t.radio&&t.radio.forEach(function(e){e.id&&n.push(e)}),t.checkbox&&t.checkbox.forEach(function(e){e.id&&n.push(e)}),t.textarea&&t.textarea.forEach(function(e){e.id&&n.push(e)}),t.dragdrop&&t.dragdrop.forEach(function(e){e.dataset.category=Array.prototype.slice.apply(e.parentNode.classList).find(function(e){return-1!=e.indexOf("ki-dd-category")})||"",e.id&&n.push(e)}),t.setLocalData(n,function(){"cloud"==t.storage?"undefined"!=typeof isKotobee?t.push(e):(t.updateNotification("success"),e&&e()):e&&e()})}},this.setLocalData=function(e,n){var a=this,t={label:kInteractive.getChapterID()+"-"+a.root.id,data:JSON.stringify(e.map(function(e){return{id:e.id,type:e.type||e.nodeName.toLowerCase(),value:-1!=["radio","checkbox"].indexOf(e.type)?e.checked:"div"==e.nodeName.toLowerCase()?e.dataset.category||"":e.value}})),overwrite:!0};kInteractive.setLocalData(t,function(e){window.unsaved="cloud"==a.storage,"cloud"!=a.storage&&a.updateNotification("success");var t={target:a};e.error?t.error=e.error:t.result=e,a.listener.emit("persister.saved",t),"function"==typeof n&&n()})},this.getLocalData=function(){var a=this;return new Promise(function(n){if("cloud"==a.storage&&"undefined"!=typeof isKotobee)try{kotobee.getData({label:kInteractive.getChapterID()+"-"+a.root.id},function(e){e.length?(a.merge(e),t()):(a.data=[],n())})}catch(e){a.listener.emit("persister.error",e.toString()),n()}else kInteractive.getLocalDataArray([{}],function(e){e.length?kInteractive.setLocalDataArray(a.cleanupData(e).map(function(e){return Object.assign(e,{overwrite:!0})}),t):t()});function t(){kInteractive.getLocalData({label:kInteractive.getChapterID()+"-"+a.root.id},function(t){if(Array.isArray(t)){if(t.length)try{a.data=JSON.parse(t[0].data)}catch(e){a.data=[],u("body.cke_editable")||a.listener.emit("persister.error",{target:a,error:'invalid or empty slot for "'+kInteractive.getChapterID()+"-"+a.root.id+'": '+JSON.stringify(t)})}else a.data=[];n()}else u("body.cke_editable")||a.listener.emit("persister.error",{target:a,error:'invalid or empty slot for "'+kInteractive.getChapterID()+"-"+a.root.id+'": '+JSON.stringify(t)})})}})},this.cleanupData=function(e){return Array.isArray(e)?e.slice(0).sort(function(e,t){return e.date>t.date?-1:e.date<t.date?1:0}).filter(function(t,e,n){return n.findIndex(function(e){return e.label==t.label})==e}):(v("error",["invalid data:",e]),[])},this.clear=function(n){var a=this;function t(e){v("warn",[e]),window.unsaved=!1;var t={target:a};e.error?t.error=e.error:t.result=e,a.listener.emit("persister.unsaved",t),"function"==typeof n&&n()}kInteractive.deleteLocalData({label:kInteractive.getChapterID()+"-"+a.root.id},function(e){e.success&&("cloud"==a.storage?kotobee.deleteData({label:kInteractive.getChapterID()+"-"+a.root.id},function(e){e.success&&t(e)}):t(e))})},this.merge=function(e){var t=this;if(1<e.length){var n=e.sort(function(e,t){return e.date>t.date?-1:e.date<t.date?1:0});v("warn",["duplicate slots:",n]);var a=n[0];v("warn",["deleting all slots matching",a.label]),kotobee.deleteData({label:a.label,all:!0},function(e){v("warn",[e]),v("warn",["insert only last slot for",a.label]),kotobee.setData(a,function(e){v("warn",[e])})})}var i=t.storageAPI.getItem("ebook-"+kInteractive.getBookID())||"[]",r=(i=JSON.parse(i)).findIndex(function(e){return e.label==kInteractive.getChapterID()+"-"+t.root.id});-1!=r&&i.splice(r,1),i=i.concat(e),i=t.cleanupData(i),t.storageAPI.setItem("ebook-"+kInteractive.getBookID(),JSON.stringify(i))},this.push=function(t){var n=this;if(n.enabled){var e=n.storageAPI.getItem("ebook-"+kInteractive.getBookID())||"[]";if(e=(e=JSON.parse(e)).map(function(e){var t=JSON.parse(JSON.stringify(e));return t.overwrite=!0,delete t.date,t}),"cloud"==n.storage)try{kotobee.setDataArray(n.cleanupData(e),function(e){v("warn",[e]),e.error,a(t)})}catch(e){a(t,e.toString())}else a(t)}function a(e,t){window.unsaved=!1,t?(n.updateNotification("error",t),n.listener.emit("persister.error",{target:n,error:t})):(n.updateNotification("success"),n.listener.emit("persister.pushed",{target:n,result:{success:"pushed"}}),n.isSaveGlobal?("function"==typeof n.saveGlobal?n.saveGlobal():"object"==typeof n.saveGlobal&&n.saveGlobal.hasOwnProperty("callback")&&n.saveGlobal.callback(),n.isSaveGlobal=!1):"function"==typeof e&&e())}},this.updateNotification=function(e,t){var n=this;try{if(n.enabled&&!kInteractive.isEditorMode())if(u(".persist-log-"+n.root.id)&&n.silentMode)switch(e){case"saving":u(".persist-log-"+n.root.id+" span.saving").style.display="block",u(".persist-log-"+n.root.id+" span.success").style.display="none",u(".persist-log-"+n.root.id+" span.error").style.display="none";break;case"success":u(".persist-log-"+n.root.id+" span.saving").style.display="none",u(".persist-log-"+n.root.id+" span.success").style.display="block",u(".persist-log-"+n.root.id+" span.error").style.display="none";break;case"error":u(".persist-log-"+n.root.id+" span.saving").style.display="none",u(".persist-log-"+n.root.id+" span.success").style.display="none",u(".persist-log-"+n.root.id+" span.error").style.display="block",u(".persist-log-"+n.root.id+" span.error").textContent=t||"Unexpected error!"}else if(u(".unsaved-changes-"+n.root.id))switch(e){case"saving":u(".unsaved-changes-"+n.root.id+" .saved").style.display="none",u(".unsaved-changes-"+n.root.id+" .saving").style.display="block",u(".unsaved-changes-"+n.root.id+" .unsaved").style.display="none",u(".unsaved-changes-"+n.root.id+" .notsaved").style.display="none",u(".unsaved-changes-"+n.root.id).classList.contains("success")&&u(".unsaved-changes-"+n.root.id).classList.remove("success"),n.silentMode||u(".unsaved-changes-"+n.root.id).classList.contains("show")||u(".unsaved-changes-"+n.root.id).classList.add("show");break;case"success":u(".unsaved-changes-"+n.root.id+" .saving").style.display="none",n.silentMode||n.isSaveGlobal?u(".unsaved-changes-"+n.root.id).classList.remove("show"):(u(".unsaved-changes-"+n.root.id).classList.add("success"),u(".unsaved-changes-"+n.root.id+" .saved").style.display="block");break;case"error":u(".unsaved-changes-"+n.root.id+" .saving").style.display="none",n.silentMode||n.isSaveGlobal?u(".unsaved-changes-"+n.root.id).classList.remove("show"):(u(".unsaved-changes-"+n.root.id).classList.add("error"),u(".unsaved-changes-"+n.root.id+" .notsaved span").textContent=t||"Unexpected error!",u(".unsaved-changes-"+n.root.id+" .notsaved").style.display="block");break;case"reset":u(".unsaved-changes-"+n.root.id+" .saved").style.display="none",u(".unsaved-changes-"+n.root.id+" .saving").style.display="none",u(".unsaved-changes-"+n.root.id+" .unsaved").style.display=n.silentMode?"none":"block",u(".unsaved-changes-"+n.root.id+" .notsaved").style.display="none",u(".unsaved-changes-"+n.root.id).classList.contains("success")&&u(".unsaved-changes-"+n.root.id).classList.remove("success"),n.silentMode||u(".unsaved-changes-"+n.root.id).classList.contains("show")||u(".unsaved-changes-"+n.root.id).classList.add("show")}}catch(e){}},this.collectInputs=function(){var e=this,t=this.getRootSelector();e.root=u(t),e.root?(e.text=u(e.root).find('input[type="text"]',!0),e.number=u(e.root).find('input[type="number"]',!0),e.radio=u(e.root).find('input[type="radio"]',!0),e.checkbox=u(e.root).find('input[type="checkbox"]:not([name="preserveAnswers"])',!0),e.textarea=u(e.root).find("textarea",!0),e.dragdrop=u(e.root).find(".ki-draggable",!0)):v("error",["unable to re-select root element by:",t])},this.handleChange=function(){var e=this;e.enabled&&(e.silentMode?e.save():e.saveGlobal&&!e.forceNotification||e.setNotify())},this.processInputs=function(){var a=this;function i(){v("warn",["persister change handler:",this.id,-1!=["radio","checkbox"].indexOf(this.type)?this.checked:this.value]),a.handleChange()}function t(e,t){document.body.addEventListener(e,function(e){e.target.id==t.id&&(-1!=["radio","checkbox"].indexOf(t.type)?t.checked=e.target.checked:t.value=e.target.value,function(a,i,r){var s;return i=i||20,r=r||!0,function(){var e=this,t=arguments,n=r&&!s;clearTimeout(s),s=setTimeout(function(){s=null,r||a.apply(e,t)},i),n&&a.apply(e,t)}}(i.bind(t),a.interval)())})}a.collectInputs();var r=0;if(a.text&&a.text.forEach(function(e){e.id||(e.id=(e.name?e.name:"tx")+"-"+r),r++,e.id&&!e.dataset.freeze&&(t("keyup",e),t("change",e))}),a.number&&a.number.forEach(function(e){e.id||(e.id=(e.name?e.name:"num")+"-"+r),r++,e.id&&!e.dataset.freeze&&(t("keyup",e),t("change",e))}),a.radio&&a.radio.forEach(function(n){n.id||(n.id=(n.name?n.name:"rb")+"-"+r),r++,n.id&&!n.dataset.freeze&&(a.enabledUncheckRadio?document.body.addEventListener("click",function(e){if(e.target.id==n.id){var t=e.target.dataset.state||"";Boolean(t.toString())?(e.target.checked=!1,e.target.dataset.state=""):e.target.dataset.state=e.target.checked,i.call(n)}}):t("change",n))}),a.checkbox&&a.checkbox.forEach(function(e){e.id||(e.id=(e.name?e.name:"cb")+"-"+r),r++,e.id&&!e.dataset.freeze&&t("change",e)}),a.textarea&&a.textarea.forEach(function(e){e.id||(e.id=(e.name?e.name:"ta")+"-"+r),r++,e.id&&!e.dataset.freeze&&(t("keyup",e),t("change",e))}),a.setRadioGroup)try{a.radio&&a.radio.forEach(function(e){e.name=e.id?e.id.match(/(.*?)(\d+)/)[0].replace("-0-",""):e.name})}catch(e){}},this.restore=function(e){var t=this;setTimeout(function(){t.getLocalData().then(function(){t.data.length&&t.data.forEach(function(e){var t=e.id;if(t)if(isNaN(t)){var n=u("#"+t);if(n)switch(e.type){case"text":case"number":case"textarea":n.value=e.value||"";break;case"radio":case"checkbox":n.checked=e.value;break;case"div":if(e.value){var a=n.cloneNode(!0);a.dataset.category=e.value,u("."+e.value).appendChild(a),n.parentNode.removeChild(n)}break;default:v("warn",["invalid input type:",e.type])}else v("error",["unable to find input by id:",t])}else v("error",["invalid input selector:",t]);else v("error",["invalid input selector:",t])}),t.renderInlineBar(),"function"==typeof e?e():(window.unsaved=!1,t.listener.emit("persister.restored",{target:t}))})},0)},this.renderSaveTab=function(e){var t=this;if(e)e.addEventListener("click",function(e){e.preventDefault(),t.isSaveGlobal=!0,t.push()});else if(!u("#save-changes")){var n=u("#tabMenu");if(n){var a=n.querySelectorAll("a:not(.chapterBtn)");if(a.length){var i=(a=a[0]).parentNode,r=a.cloneNode(!0);r.id="save-changes",r.querySelector(".icon").className="icon ion-"+(t.saveGlobal.icon||"checkmark-circled"),r.querySelector(".tab-title").innerText=t.saveGlobal.label||t.messages.save,i.insertAdjacentHTML("beforeend",r.outerHTML)}u("#save-changes").addEventListener("click",function(e){e.preventDefault(),t.isSaveGlobal=!0,t.push()})}}},this.init=function(){var t=this;kInteractive.isEditorMode()||(t.delegateEvents&&t.processInputs(),t.enabled&&(t.renderInlineBar(),t.renderFloatingBar()),window.addEventListener("beforeunload",function(e){"undefined"!=typeof kotobee&&(-1!=!location.hostname.indexOf("localhost")&&-1!=!location.hostname.indexOf("127.0.0.1")||"undefined"!=typeof config&&!config.kotobee.public||t.testMode)&&window.unsaved&&(t.setNotify(),e.preventDefault(),e.returnValue="",delete e.returnValue)})),window.unsaved=!1,t.listener.emit("persister.ready",{target:t})},this.listener=new function(){this.listeners={},this.on=function(e,t){return this.addListener(e,t)},this.once=function(e,t){this.listeners[e]=this.listeners[e]||[];var n=function(){t(),this.off(e,n)};return this.listeners[e].push(n),this},this.off=function(e,t){return this.removeListener(e,t)},this.die=function(e){return this.removeAllListeners(e)},this.addListener=function(e,t){return this.listeners[e]=this.listeners[e]||[],this.listeners[e].push(t),this},this.removeListener=function(e,t){var n=this.listeners[e]||[];return this.listeners[e]=n.filter(function(e){return e!==t}),this},this.removeAllListeners=function(e){return delete this.listeners[e],this},this.emit=function(){if(arguments.length<1)return!1;var e=arguments[0],t=this.listeners[e];if(!t)return!1;var n=1<arguments.length?Array.prototype.slice.call(arguments).slice(1):[];return t.forEach(function(e){e.apply(this,n)}),!0},this.listListeners=function(e){return this.listeners[e]||[]}};var t,n=this;function u(e){if(arguments.length<1)return null;var t=e,i=null;if("string"==typeof t){var n=!1,a=document;if(1<arguments.length)for(var r,s=Array.prototype.slice.call(arguments).slice(1),o=0;o<s.length;o++)"boolean"==typeof(r=s[o])?n=r:"object"==typeof r&&(a=r);if(0==(i=Array.prototype.slice.call(a.querySelectorAll(t))).length)return null;i=n||1!=i.length?i:i[0]}else i=t;return Array.isArray(i)||(i.find=function(e,t){return u(e,i,t)},i.parents=function e(t){var n=null;var a=-1!=t.indexOf(".")?t.split(".")[1]:"";i.parentNode.nodeName.toLowerCase()==t.toLowerCase()||""!=a&&i.parentNode.classList.contains(a)||i.parentNode.id==t.replace("#","")?n=i.parentNode:"body"==i.parentNode.nodeName.toLowerCase()||n||(i=i.parentNode,n=e(t));return n},i.closest=function(e){return function(e,t){for(Element.prototype.matches||(Element.prototype.matches=Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector||function(e){for(var t=(this.document||this.ownerDocument).querySelectorAll(e),n=t.length;0<=--n&&t.item(n)!==this;);return-1<n});e&&e!==document;e=e.parentNode)if(e.matches(t))return e;return null}(i,e)},i.ascendants=function(e){return function(e){Element.prototype.matches||(Element.prototype.matches=Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector||function(e){for(var t=(this.document||this.ownerDocument).querySelectorAll(e),n=t.length;0<=--n&&t.item(n)!==this;);return-1<n});for(var t=[];e&&e!==document;e=e.parentNode)t.push(e);return t}(i)}),i}function v(e,t){"dev"==(window.debug||-1!=location.hostname.indexOf(".local")||-1!=location.hostname.indexOf("kotobee.com")||-1!=location.hostname.indexOf("localhost")||-1!=location.hostname.indexOf("localhost")||-1!=location.hostname.indexOf("192.168.")?"dev":"production")&&console[e].apply(null,t)}(t=this.listener,Object.getOwnPropertyNames(t).filter(function(e){return"function"==typeof t[e]})).forEach(function(e){n[e]||(n[e]=n.listener[e].bind(n.listener))}),e&&this.setOptions(e),this.storageAPI=-1!=["session","cloud"].indexOf(this.storage)?sessionStorage:localStorage,kInteractive.setStorage(this.storageAPI)}kInteractive.setStorage(),kInteractive.container={preRender:function(e,t){kInteractive.readData(e)},postRender:function(e,t,n){var a=kInteractive.readData(t);if(a&&(kInteractive.isMobile()&&"cScroll"==a.type&&"undefined"!=typeof isKotobee&&angular.element(document.body).scope().applyNativeScroll(t),a.path)){var i=a.path;"undefined"!=typeof isKotobee&&(i=ph.join(kInteractive.absoluteURL,a.path));var r=t.getAttribute("style");i=kInteractive.cleanURL(i),t.setAttribute("style",r+' background-image:url("'+i+'");')}},action:function(e){},resize:function(e){var t=kInteractive.readData(e);t&&kInteractive.checkResponsiveFloat(t,e)}},kInteractive.equation={preRender:function(e,t){if(!kInteractive.isEditorMode()&&"undefined"==typeof MathJax){MathJax={loader:{load:["input/asciimath","input/mml","input/tex","output/chtml","ui/menu"]}};var n=document.createElement("script"),a="";a="undefined"==typeof isKotobee?"../../js/lib/mathjax/startup.js":bookPath+"EPUB/js/lib/mathjax/startup.js",n.src=kInteractive.cleanURL(a),n.setAttribute("type","text/javascript"),document.head.appendChild(n)}},postRender:function(e,t,n){var a=e.createDocumentFragment(),i=kInteractive.readData(t);if(i){t.setAttribute("id","ki-equation-"+n),t.innerHTML="";var r=i.content;"mathml"==i.type?r="<math>"+r+"</math>":"asciimath"==i.type?r="`"+r+"`":"tex"==i.type&&(r="\\("+r+"\\)");var s="inline"==i.placement?"span":"div",o=document.createElement(s);o.setAttribute("id","ki-equation-"+n+"-container"),o.className="parsed container",o.innerHTML=r;var c=document.createElement(s);i.style&&kInteractive.c.addClass(c,i.style),a.appendChild(o),c.appendChild(a),t.appendChild(c),kInteractive.isEditorMode()||MathJax&&MathJax.typeset&&MathJax.typeset()}},action:function(e){kInteractive.readData(e)},resize:function(e){kInteractive.readData(e)}},kInteractive.gallery={preRender:function(e,t){var n=t.createDocumentFragment(),a=kInteractive.readData(e);if(a){e.innerHTML="";var i=e.getAttribute("data-index");i=i||0;var r=document.createElement("div");r.className="imgMask";var s=document.createElement("div");s.className="images "+a.scale,r.appendChild(s);for(var o=0;o<a.imgs.length;o++){var c=document.createElement("div");c.className="imgContainer ki-btn";var l="undefined"==typeof isKotobee?a.imgs[o].path:ph.join(kInteractive.absoluteURL,a.imgs[o].path);l=kInteractive.cleanURL(l),c.setAttribute("style","background-color:"+a.bgColor+";background-image:url('"+l+"')"),a.imgs[o].caption&&c.setAttribute("data-caption",a.imgs[o].caption),"undefined"!=typeof isKotobee||kInteractive.c.hasClass(e,"fullscreen")||c.addEventListener("click",kInteractive.actionEvent),s.appendChild(c)}var d=document.createElement("div");d.className="navBtns";var u=document.createElement("a");u.className="next btn ki-btn",d.appendChild(u);var v=document.createElement("a");v.className="prev btn ki-btn",d.appendChild(v),n.appendChild(d),"undefined"!=typeof isKotobee&&!kInteractive.c.hasClass(e,"fullscreen")||(u.addEventListener("click",kInteractive.actionEvent),v.addEventListener("click",kInteractive.actionEvent)),n.appendChild(r);var p=document.createElement("div");p.className="kFooter",a.footerShadow&&(p.className+=" shadow"),n.appendChild(p);var m=document.createElement("div");m.className="imgCaption";var h=document.createElement("div");if(h.className="inner",h.style.display="none",a.imgs[0]&&a.imgs[0].caption&&(h.innerHTML=a.imgs[0].caption,h.style.display=null),m.appendChild(h),p.appendChild(m),a.thumbnails){var f=document.createElement("div");f.className="kThumbs",a.thumbShowOnHover&&(f.className+=" showOnHover"),"small"==a.thumbSize?kInteractive.c.addClass(f,"small"):"large"==a.thumbSize?kInteractive.c.addClass(f,"large"):kInteractive.c.addClass(f,"medium"),p.appendChild(f)}if(kInteractive.c.hasClass(e,"fullscreen")){var g=document.createElement("div");g.className="fullscreenControls",g.innerHTML="<a class='closeBtn ki-btn'></a>",e.appendChild(g),g.children[0].addEventListener("click",kInteractive.actionEvent),document.addEventListener("keydown",kInteractive.gallery.detectKey)}var k=document.createElement("div");a.style&&kInteractive.c.addClass(k,a.style),k.appendChild(n),e.appendChild(k),kInteractive.gallery.dimBtns(e),kInteractive.gallery.resize(e),this.showImage(e,{index:i,dontGoFullscreen:!0}),setTimeout(function(){kInteractive.gallery.showImage(e,{index:i,dontGoFullscreen:!0})},80)}},postRender:function(e,t,n){kInteractive.gallery.resize(t);var a=this.getState(t);this.showImage(t,{index:a.selectedIndex,dontGoFullscreen:!0})},action:function(e,t){e.getElementsByClassName("images")[0].getElementsByClassName("selected")[0];if(kInteractive.hasClass(t,"btn"))kInteractive.hasClass(t,"next")?kInteractive.gallery.showImage(e,{dir:"next"}):kInteractive.hasClass(t,"prev")&&kInteractive.gallery.showImage(e,{dir:"prev"});else if(kInteractive.hasClass(t,"closeBtn"))kInteractive.gallery.exitFullscreen();else{if(kInteractive.hasClass(t,"imgContainer"))return kInteractive.gallery.goToFullscreen(e);if(kInteractive.hasClass(t,"kMapItem")){var n=kInteractive.getChildIndex(t);kInteractive.gallery.goToThumb(e,{windowIndex:n,highlightThumb:!1})}else if(kInteractive.hasClass(t,"kThumb")){n=t.getAttribute("data-index");kInteractive.gallery.showImage(e,{index:t.getAttribute("data-index")})}else if(kInteractive.hasClass(t,"thumbNavBtn")){kInteractive.hasClass(t,"next")?kInteractive.gallery.goToThumb(e,{dir:"nextWindow",highlightThumb:!1}):kInteractive.hasClass(t,"prev")&&kInteractive.gallery.goToThumb(e,{dir:"prevWindow",highlightThumb:!1})}}kInteractive.gallery.dimBtns(e)},goToThumb:function(e,t){t=t||{};var n,a,i=this.getState(e),r=i.thumbWindows,s=i.activeWindow,o=i.currentIndex,c=i.selectedIndex,l=i.currentThumb,d=t.index;if(null==d&&(null!=t.windowIndex?d=t.windowIndex*r[0].children[0].children.length:("nextThumb"==t.dir&&(d=c+1),"prevThumb"==t.dir&&(d=c-1),"nextWindow"==t.dir&&(d=o+r[0].children[0].children.length),"prevWindow"==t.dir&&(d=o-r[0].children[0].children.length))),r.length)for(var u=r[0].getElementsByClassName("kThumb"),v=u.length;v--;)if(u[v].getAttribute("data-index")==d){n=u[v],a=n.parentNode;break}if(a){if(s!=a){o<d?(s.style.left=-e.offsetWidth+"px",a.style.left=e.offsetWidth/2+"px"):(s.style.left=e.offsetWidth+"px",a.style.left=-e.offsetWidth/2+"px"),a.style.display="none",setTimeout(function(){a.style.display="block",setTimeout(function(){a.style.left=0},20)},20);var p=e.getElementsByClassName("kMapItem");p.length&&(s&&kInteractive.c.removeClass(p[kInteractive.getChildIndex(s)],"active"),kInteractive.c.addClass(p[kInteractive.getChildIndex(a)],"active")),kInteractive.c.addClass(a,"active"),kInteractive.c.removeClass(s,"active")}t.highlightThumb&&(kInteractive.c.removeClass(l,"active"),kInteractive.c.addClass(n,"active"))}},dimBtns:function(e){for(var t,n=e.getElementsByClassName("kThumbWindow"),a=n.length;a--;)if(kInteractive.c.hasClass(n[a],"active")){t=n[a];break}if(t){var i=e.getElementsByClassName("thumbNavBtn");for(a=0;a<i.length;a++)kInteractive.c.hasClass(i[a],"next")?t.nextElementSibling?kInteractive.c.removeClass(i[a],"disable"):kInteractive.c.addClass(i[a],"disable"):kInteractive.c.hasClass(i[a],"prev")&&(t.previousElementSibling?kInteractive.c.removeClass(i[a],"disable"):kInteractive.c.addClass(i[a],"disable"))}var r=e.getElementsByClassName("imgContainer");if(r.length){var s=kInteractive.c.hasClass(r[0],"selected"),o=kInteractive.c.hasClass(r[r.length-1],"selected"),c=e.getElementsByClassName("btn");for(a=0;a<c.length;a++)kInteractive.c.hasClass(c[a],"next")?o?kInteractive.c.addClass(c[a],"disable"):kInteractive.c.removeClass(c[a],"disable"):kInteractive.c.hasClass(c[a],"prev")&&(s?kInteractive.c.addClass(c[a],"disable"):kInteractive.c.removeClass(c[a],"disable"))}},getState:function(e){var t={};t.images=e.getElementsByClassName("images")[0],t.selectedImg=t.images.getElementsByClassName("selected"),t.imgContainer=e.getElementsByClassName("imgContainer"),t.thumbWindows=e.getElementsByClassName("kThumbWindows");for(var n=0;n<t.imgContainer.length;n++)if(kInteractive.c.hasClass(t.imgContainer[n],"selected")){t.selectedIndex=n;break}if(t.thumbWindows.length){var a=t.thumbWindows[0].getElementsByClassName("active");for(n=0;n<a.length;n++)kInteractive.c.hasClass(a[n],"kThumbWindow")?(t.activeWindow=a[n],t.currentIndex=Number(t.activeWindow.children[0].getAttribute("data-index"))):t.currentThumb=a[n]}return t},goToFullscreen:function(e){if(!kInteractive.c.hasClass(e,"fullscreen")){var t=document.createElement("div");t.innerHTML=e.outerHTML;var n=t.children[0];document.body.appendChild(n);var a=this.getState(e),i=e.getBoundingClientRect();n.setAttribute("data-index",a.selectedIndex),n.setAttribute("id","kFullscreenGallery"),n.style.top=i.top+"px",n.style.left=i.left+"px",n.style.width=i.width+"px",n.style.height=i.height+"px",kInteractive.listenForSwiping(n),n.addEventListener("swipeleft",function(){kInteractive.gallery.showImage(n,{dir:"next"})}),n.addEventListener("swiperight",function(){kInteractive.gallery.showImage(n,{dir:"prev"})},!1),"undefined"==typeof isKotobee&&(n.style.position="fixed"),kInteractive.c.addClass(n,"fullscreen"),kInteractive.preRender(n,{singleElem:!0}),kInteractive.postRender(n,{singleElem:!0}),setTimeout(function(){kInteractive.c.addClass(n,"in")},20)}},showImage:function(e,t){t=t||{};var n=kInteractive.readData(e),a=this.getState(e),i=a.images,r=a.selectedImg,s=a.imgContainer,o=t.index;if(null==o&&r.length&&(o=kInteractive.getChildIndex(r[0])+("next"==t.dir?1:-1)),o<0&&(o=0),null==o&&(o=0),!t.dontGoFullscreen&&o==a.selectedIndex)return kInteractive.gallery.goToFullscreen(e);r.length&&kInteractive.c.removeClass(r[0],"selected"),kInteractive.c.addClass(s[o],"selected"),s[o].style.left=i.offsetWidth*o+"px",s[o].style.display="block",i.style.left=-i.offsetWidth*o+"px",this.goToThumb(e,{index:o,highlightThumb:!0});var c=e.getElementsByClassName("imgCaption");if(c.length){var l=(c=c[0]).getElementsByClassName("inner");if(l.length&&((l=l[0]).style.display="none",s[o].hasAttribute("data-caption")&&(l.innerHTML=s[o].getAttribute("data-caption"),n.captionFontSize&&(l.style.fontSize=n.captionFontSize+"em"),n.captionColor&&(l.style.color=n.captionColor),l.style.display=null),!n.footerOverlap)){var d=e.getElementsByClassName("imgMask");if(!d.length)return;d=d[0];var u=e.getElementsByClassName("kFooter")[0];d.style.bottom=u.offsetHeight+"px"}}},detectKey:function(e){kInteractive.gallery.exitFullscreen()},exitFullscreen:function(){var e=document.getElementById("kFullscreenGallery");e&&(kInteractive.c.removeClass(e,"in"),e.style.opacity=0,setTimeout(function(){e.parentNode.removeChild(e),document.removeEventListener("keydown",kInteractive.gallery.detectKey)},1e3))},resize:function(e){var t=kInteractive.readData(e);if(t&&(kInteractive.checkResponsiveFloat(t,e),t.thumbnails)){var n=kInteractive.gallery.getState(e).selectedIndex;null==n&&(e.getAttribute("data-index"),n=n||0);var a=e.getElementsByClassName("kThumbs")[0];a.innerHTML="";var i=50;"small"==t.thumbSize?i=40:"large"==t.thumbSize&&(i=60);var r,s=Math.floor((e.offsetWidth-80)/i),o=document.createElement("div");o.className="kThumbWindows";for(var c=0;c<t.imgs.length;c++)if(t.imgs[c].thumbPath){var l=document.createElement("a");l.className="ki-btn kThumb"+(c==n?" active":""),l.setAttribute("data-index",c);var d="undefined"==typeof isKotobee?t.imgs[c].thumbPath:ph.join(kInteractive.absoluteURL,t.imgs[c].thumbPath);d=kInteractive.cleanURL(d),l.setAttribute("style","background-image:url('"+d+"')"),"undefined"!=typeof isKotobee&&!kInteractive.c.hasClass(e,"fullscreen")||l.addEventListener("click",kInteractive.actionEvent),c%s==0&&((r=document.createElement("div")).className="kThumbWindow",o.appendChild(r)),c==n&&kInteractive.c.addClass(r,"active"),r.appendChild(l)}if(a.appendChild(o),t.thumbMap){var u=document.createElement("div");u.className="kThumbMap";for(c=0;c<t.imgs.length;c++)if(c%s==0){var v=document.createElement("a");v.className="ki-btn kMapItem"+(c==n?" active":""),u.appendChild(v),"undefined"!=typeof isKotobee&&!kInteractive.c.hasClass(e,"fullscreen")||v.addEventListener("click",kInteractive.actionEvent)}a.appendChild(u)}if(1<o.children.length){var p=document.createElement("a");p.className="thumbNavBtn next",a.appendChild(p);var m=document.createElement("a");m.className="thumbNavBtn prev",a.appendChild(m),"undefined"!=typeof isKotobee&&!kInteractive.c.hasClass(e,"fullscreen")||(p.addEventListener("click",kInteractive.actionEvent),m.addEventListener("click",kInteractive.actionEvent))}}}},kInteractive.image={preRender:function(e,t){var n=kInteractive.readData(e);n&&(n.style&&kInteractive.c.addClass(e,n.style),n.popup&&n.splash&&(e.src=n.splash),e.parentNode&&kInteractive.hasClass(e.parentNode,"link")||"undefined"==typeof isKotobee&&e.addEventListener("click",kInteractive.actionEvent))},postRender:function(e,t,n){kInteractive.readData(t)},action:function(e,a,t){if(a.parentNode&&kInteractive.hasClass(a.parentNode,"kInteractive")&&kInteractive.hasClass(a.parentNode,"link"))kInteractive.action(a.parentNode,event);else{var n=kInteractive.readData(a);if(n){var i=n.behavior;if("none"!=i)o(a,"none"),c(a,"none"),l(a,"none"),setTimeout(function(){"wiggle"==i?(o(a,"wiggle"),c(a,"0.5s"),l(a,"1")):"jump"==i?(o(a,"jump"),c(a,"0.7s"),l(a,"1")):"scale"==i&&(o(a,"scale"),c(a,"0.5s"),l(a,"1"));var n=function(){var e,t=document.createElement("fakeelement"),n={animation:"animationend",OAnimation:"oAnimationEnd",MozAnimation:"animationend",WebkitAnimation:"webkitAnimationEnd"};for(e in n)if(void 0!==t.style[e])return n[e]}();n&&a.addEventListener(n,function e(t){o(a,"none"),c(a,"none"),l(a,"none"),a.removeEventListener(n,e)})}),kInteractive.tinCan({verb:"clicked",activity:i+"image: "+a.getAttribute("src")});else if(n.popup){var r={class:"image"},s=document.createElement("img");s.src=n.path,kInteractive.isAbsolutePath(n.path)||"undefined"!=typeof isKotobee&&(s.src=ph.join(kInteractive.absoluteURL,n.path)),r.width=s.naturalWidth,r.height=s.naturalHeight,r.pos="side",r.cb=function(e){e.appendChild(s)},r.closed=function(){},kInteractive.openFrame(r)}}}function o(e,t){e.style.webkitAnimation=e.style.mozAnimation=e.style.animation=t}function c(e,t){e.style.webkitAnimationDuration=e.style.mozAnimationDuration=e.style.animationDuration=t}function l(e,t){e.style.webkitAnimationIterationCount=e.style.mozAnimationIterationCount=e.style.animationIterationCount=t}},resize:function(e){var t=kInteractive.readData(e);t&&kInteractive.checkResponsiveFloat(t,e)}},kInteractive.link={preRender:function(e,t){var n=kInteractive.readData(e);if(n&&!kInteractive.isEditorMode()){if("#"==e.getAttribute("href")&&e.setAttribute("href",""),"div"==e.nodeName.toLowerCase()){var a=document.createElement("a"),i=e.getAttribute("href")?e.getAttribute("href"):n.href;e.getAttribute("data-href")&&(i=e.getAttribute("data-href")),i=i||"",a.setAttribute("href",i),a.setAttribute("target",n.target?n.target:""),a.setAttribute("style",e.getAttribute("style")),a.setAttribute("data-kotobee",e.getAttribute("data-kotobee")),a.className=e.className,e.id?a.id=e.id:n.id&&(a.id=n.id),kInteractive.c.addClass(a,"btn"),a.style.opacity=Number(n.transparency)/100,e.parentNode.replaceChild(a,e),e=a}"undefined"==typeof isKotobee&&("popup"!=n.type&&"audio"!=n.type&&"action"!=n.type||e.setAttribute("onclick","return false;"),e.addEventListener("click",kInteractive.actionEvent))}},postRender:function(e,t,n){},action:function(t,e,n){var a=kInteractive.readData(e);if(a){if("popup"==a.type){var i="<div class='kbAlertScroll'>"+a.msg+"</div>";if(i=i.replace(/src="(.*?)"/g,function(){var e=arguments[1];return"undefined"!=typeof isKotobee&&(e=ph.join(kInteractive.absoluteURL,e)),'src="'+e+'"'}),"image"==a.popupMode){var r=a.popupImg;"undefined"!=typeof isKotobee&&(r=a.relToRoot?ph.join(bookPath,r):ph.join(kInteractive.absoluteURL,r)),i="<img src='"+(r=kInteractive.cleanURL(r))+"'/>"}kInteractive.alert({content:i}),setTimeout(function(){if(kInteractive.scorm){var e={};e.id=kInteractive.getScormId("popup",a.msg),e.description="Shown popup message: "+a.msg,e.type="other",e.learnerResponses="Shown",e.timestamp=new Date,kInteractive.scorm.setInteractions([e])}kInteractive.events&&kInteractive.events.add({action:"popup",param:a.msg,elem:t,data:a})})}else if("action"==a.type){var s=a.asset,o=a.action;if(s.remote){if("widget"==s.type){var c=document.createElement("div");c.className="kInteractive widget kbHidden",c.setAttribute("data-kotobee",s.data),document.body.appendChild(c),kInteractive.trigger("click",c)}return}for(var l=document.getElementsByClassName(s.classname),d=0;d<l.length;d++)if(kInteractive.hasClass(l[d],"kInteractive")&&kInteractive.hasClass(l[d],s.type))if("activate"==o)if("gallery"==s.type){var u=l[d].getElementsByClassName("next");kInteractive.trigger("click",u[0])}else if("questions"==s.type){for(var v=l[d].getElementsByClassName("ki-btn"),p=0;p<v.length;p++)if("submit"==v[p].type){kInteractive.trigger("click",v[p]);break}}else kInteractive.trigger("click",l[d]);else"visibility"==o&&kInteractive.c.toggleClass(l[d],"kbHidden")}else if("audio"==a.type){kInteractive.stopCurrentMedia();var m,h=document.createElement("audio"),f=a.src;function g(){m||(kInteractive.c.addClass(b,"hide"),m=!0)}"file"==a.audioType&&(f="undefined"==typeof isKotobee?a.audio:ph.join(kInteractive.absoluteURL,a.audio)),h.setAttribute("src",f);var k=document.createElement("div");k.className="kiAudioLoader",k.style.transform=k.style.webkitTransform=k.style.mozTransform="scale(1)";var b=document.createElement("div");if(b.className="kiAudioSpinner",k.appendChild(b),e.parentNode.insertBefore(k,e),h.onplaying=g,setTimeout(g,5e3),h.play(),kInteractive.currentAudio=h,kInteractive.tinCan({verb:"played",activity:"Audio: "+f}),kInteractive.scorm){var y={};y.id=kInteractive.getScormId(e.textContent,f),y.description="Played audio link: "+f,y.type="other",y.learnerResponses="Played",y.objective=a.options?a.options.objective:null,y.timestamp=new Date,kInteractive.scorm.setInteractions([y])}kInteractive.events&&kInteractive.events.add({action:"audioLinkClicked",param:f,elem:t,data:a})}else if("attachment"==a.type){var I=a.file;if("undefined"!=typeof isKotobee&&(I=a.relToRoot?ph.join(bookPath,a.file):ph.join(kInteractive.absoluteURL,a.file)),"undefined"!=typeof kotobee&&native)return void angular.element(document.body).scope().getService("crdv").mobileDownload(I);var C=document.createElement("a");document.body.appendChild(C),C.setAttribute("style","display: none"),C.href=kInteractive.cleanURL(I),C.target="_blank",C.download=a.file.split("/")[a.file.split("/").length-1],C.setAttribute("onclick","");var E=document.createEvent("MouseEvents");E.initMouseEvent("click"),C.dispatchEvent(E),C.remove()}return!1}}},kInteractive.lipsync={preRender:function(e,t){},postRender:function(e,t,n){var a,i=e.createDocumentFragment(),r=kInteractive.readData(t);t.setAttribute("id",a="ki-lipsync-"+n),t.innerHTML="";var s=document.createElement("div");if(s.className="container",r.sync){var o=document.createElement("div");o.className="audioContainer";var c=document.createElement("a");c.className="playBtn ki-btn",c.appendChild(document.createElement("span")),"undefined"==typeof isKotobee&&c.addEventListener("click",kInteractive.actionEvent),o.appendChild(c);var l=document.createElement("div");l.setAttribute("id",a+"-container"),l.className="playerContainer",o.appendChild(l),r.interaction.playBtn?r.interaction.btnAlignment&&kInteractive.c.addClass(o,r.interaction.btnAlignment):o.style.display="none",s.appendChild(o)}var d=document.createElement("div");d.className="contentContainer",d.innerHTML=function(e){document.createElement("div");var t=/(>)([^<\n]*?[^<]+?)(<[^\/])/g;e=e.replace(/([< \/][^>]*?>)((\s*[^<\s]+\s+?)+)([^<\s]+\s*)(<)/g,function(e,t){if(0<=t.indexOf('class="parsed"'))return e;if(0==t.indexOf("<pre"))return e;if(0==t.indexOf("<code"))return e;if(0==t.indexOf("<script"))return e;var n=arguments[2].split(" ");""==n[n.length-1]&&n.splice(-1,1),n.push(arguments[4]);for(var a="",i=0;i<n.length;i++){var r=i==n.length-1?"":" ";a+="<span>"+n[i]+r+"</span>"}return t+a+"<"}),e=e.replace(t,function(e,t){return arguments[2].trim()?t+("<span>"+arguments[2]+"</span>")+arguments[3]:e});return e=(e=e.replace(/(<a [\s\S]*?)(>)/g,'$1 onclick="return false;" $2')).replace(/&nbsp;/g,"&#160;")}(r.content),s.appendChild(d);var u=document.createElement("div");r.style&&kInteractive.c.addClass(u,r.style),i.appendChild(s),u.appendChild(i),t.appendChild(u);var v=document.createElement("style");v.className="parsed";var p="";if(p+="#"+a+" .lipSyncCurrentWord {",p+="color:"+r.layout.color+";",r.layout.underline&&(p+="text-decoration:underline;"),r.layout.scale&&1<Number(r.layout.scale)&&(p+="transform:scale("+r.layout.scale+");",p+="padding:0 3px;",p+="display:inline-block;"),p+="}",v.innerHTML=p,t.appendChild(v),r.autoplay)kInteractive.action(t)},action:function(i,e){kInteractive.stopCurrentMedia();var r=kInteractive.readData(i);if(r){r.audioType||(r.audioType=r.type);i.getAttribute("id");i.getElementsByClassName("playBtn")[0].className="playBtn ki-btn hide";var t=r.src;if("file"==r.audioType&&(t="undefined"==typeof isKotobee?r.audio:r.relToRoot?ph.join(bookPath,r.audio):ph.join(kInteractive.absoluteURL,r.audio)),kInteractive.scorm){var n={};n.id=kInteractive.getScormId(i.getAttribute("id"),t),n.description="Played audio: "+t,n.type="other",n.learnerResponses="Played",n.objective=r.options?r.options.objective:null,n.timestamp=new Date,kInteractive.scorm.setInteractions([n])}kInteractive.events&&kInteractive.events.add({action:"audioPlayed",param:t,elem:i,data:r});var a=document.createElement("audio");a.setAttribute("controls","true"),a.setAttribute("autoplay","true"),a.setAttribute("data-tap-disabled","false");var s=document.createElement("source");s.src=kInteractive.cleanURL(t),a.appendChild(s),a.appendChild(document.createTextNode("Your browser does not support the audio element")),a.className="ki-noHighlight",a.oncanplay=function(){kInteractive.currentAudio==i&&kInteractive.tinCan({verb:"played",activity:"Audio: "+t})},a.ontimeupdate=function(e){!function(e){var t,n=r;for(var a=n.sync.length;a--;)if(e>=n.sync[a]){t=a;break}if(null==t)return;c!=t&&(null!=c&&o[c]&&kInteractive.c.removeClass(o[c],"lipSyncCurrentWord"),o[t]&&kInteractive.c.addClass(o[t],"lipSyncCurrentWord"),c=t)}(a.currentTime)},i.getElementsByClassName("playerContainer")[0].appendChild(a),a.play(),kInteractive.currentAudio=i,kInteractive.c.addClass(kInteractive.currentAudio,"playing");var o=function(){for(var e=[],t=i.getElementsByClassName("contentContainer")[0],n=t.getElementsByClassName("lipSyncCurrentWord"),a=n.length;a--;)hasClass(n[a],"lipSyncCurrentWord")&&removeClass(n[a],"lipSyncCurrentWord");for(;t.children&&t.children.length;)t=t.children[0];e.push(t);for(;t;)if(t.nextSibling){for(t=t.nextSibling;t.children&&t.children.length;)t=t.children[0];if(3==t.nodeType)continue;if(""==t.textContent)continue;e.push(t)}else if("contentContainer"==(t=t.parentNode).className)break;return e}(),c=0;kInteractive.c.addClass(o[c],"lipSyncCurrentWord")}}},kInteractive.questions={preRender:function(e,t,n,a){var i=t.createDocumentFragment(),r=kInteractive.readData(e);if(r){var s=r.dict,o=r.userDict;if(s=s||{},o=o||s,r.options||(r.options={}),e.id||(e.id="ki-qs-"+n+"-"+Math.ceil(1e3*Math.random())),e.innerHTML="",r.layout&&r.layout.popup&&!kInteractive.hasClass(e,"inpopup")){var c=document.createElement("img"),l=r.layout.popupImg;return l=kInteractive.cleanURL(l),c.src=l,i.appendChild(c),"undefined"==typeof isKotobee&&c.addEventListener("click",kInteractive.actionEvent),void e.appendChild(i)}if(r.options.randomize){for(var d=0;d<r.q.length;d++)r.q[d].origin=d;for(var u,v,p=r.q.length;0!==p;)v=Math.floor(Math.random()*p),p-=1,u=r.q[p],r.q[p]=r.q[v],r.q[v]=u}if(r.options.questionsDisplayed){var m=Number(r.options.questionsDisplayed);r.q=r.q.slice(0,m)}if(r.title){var h=document.createElement("span");h.innerHTML="<h4>"+kInteractive.escapeHtml(r.title)+"</h4>",i.appendChild(h)}var f=null;r.options&&r.options.emailForm&&(f=this.f.createEmailForm(o));var g=null;"none"!=r.action&&(g=this.f.createSubmitBtn(o,e));var k=null,b=null,y=null;r.options&&r.options.clearAnswers&&(k=this.f.createClearBtn(o)),r.options&&r.options.addToNotebook&&(y=this.f.createAddToNotebookBtn(o)),r.options&&r.options.preserveAnswers&&(b=this.f.createPreserveBtn(o,e,r.options.preserveAnswers,r.layout.persist||{}));var I=this.f.createSeparator(),C=document.createElement("div");C.className="qContainer";var E=document.createElement("div");if(E.className="btnContainer","slides"==r.options.displayMode)e.qIndex=0,C.appendChild(kInteractive.questions.f.createQElem(r,{index:0,elem:e,rendered:!1})),i.appendChild(C),i.appendChild(E),kInteractive.questions.f.showNavBtns(0,i,{isFrag:!0,userDict:o,qsData:r});else{for(d=0;d<r.q.length;d++)C.appendChild(kInteractive.questions.f.createQElem(r,{index:d,elem:e,rendered:!1}));i.appendChild(C),f&&E.appendChild(f),g&&E.appendChild(g),E.appendChild(document.createTextNode(" ")),y&&E.appendChild(y),k&&E.appendChild(k),b&&E.appendChild(b),I&&i.appendChild(I),i.appendChild(E)}r.options.rtl?(e.setAttribute("dir","rtl"),kInteractive.c.addClass(e,"rtl")):e.setAttribute("dir","ltr");var w=document.createElement("div");r.style&&kInteractive.c.addClass(w,r.style),w.appendChild(i),e.appendChild(w)}},postRender:function(e,t,n){var a=kInteractive.readData(t);if(a){var i=a.dict,r=a.userDict;i=i||{},r=r||i;for(var s=t.getElementsByClassName("ques"),o=t.getElementsByClassName("explanation"),c=o.length;c--;)o[c].parentNode.removeChild(o[c]);var l=t.getElementsByClassName("reference");for(c=l.length;c--;)l[c].parentNode.removeChild(l[c]);for(var d=0;d<s.length;d++){var u=s[d].getElementsByClassName("ans"),v=(u.length,d);a.options.randomize&&(v=Number(s[d].getAttribute("data-o"))),document[t.id]&&document[t.id].preserve&&document[t.id].q&&document[t.id].q[v]&&kInteractive.questions.f.showExp(a.userDict,s[d],a.q[v]);for(c=0;c<u.length;c++)if(kInteractive.c.removeClass(u[c].parentNode,"correct"),0<=u[c].getAttribute("id").indexOf("ki-tf-"))document[t.id]&&document[t.id].preserve&&document[t.id].q&&document[t.id].q[v]&&(document[t.id].q[v][c]?u[c].setAttribute("checked",!0):u[c].removeAttribute("checked"),a.options&&a.options.highlightCorrect&&(0==c&&a.q[v].a||1==c&&!a.q[v].a)&&kInteractive.c.addClass(u[c].parentNode,"correct"));else if(0<=u[c].getAttribute("id").indexOf("ki-dd-")){if(document[t.id]&&document[t.id].preserve&&document[t.id].q&&document[t.id].q[v])for(var p=0;p<document[t.id].q[v].length;p++){var m=document[t.id].q[v][p];try{for(var h=document.getElementById(m.id),f=h;!kInteractive.c.hasClass(f,"ques");)f=f.parentNode;f.getElementsByClassName("categoryContainer")[0].children[m.category].appendChild(h)}catch(e){}}}else 0<=u[c].getAttribute("id").indexOf("ki-sa-")?document[t.id]&&document[t.id].preserve&&document[t.id].q&&document[t.id].q[v]&&(u[c].removeAttribute("value"),document[t.id].q[v]&&u[c].setAttribute("value",document[t.id].q[v])):document[t.id]&&document[t.id].preserve&&document[t.id].q&&document[t.id].q[v]&&(document[t.id].q[v][c]?u[c].setAttribute("checked",!0):u[c].removeAttribute("checked"),a.options&&a.options.highlightCorrect&&a.q[v].c[c].a&&kInteractive.c.addClass(u[c].parentNode,"correct"));if(document[t.id]){var g=t.getElementsByClassName("questions-preserve");g.length&&(document[t.id].preserve?g[0].setAttribute("checked",!0):g[0].removeAttribute("checked"))}}if(!kInteractive.isEditorMode()){var k=t.querySelector("input.questions-preserve");if(k){var b="persist-"+kInteractive.getBookID()+"-"+t.id,y="true"==sessionStorage.getItem(b)||void 0!==k.dataset.auto&&"true"==k.dataset.auto;if(y?k.setAttribute("checked",!0):k.removeAttribute("checked"),kInteractive.helpers&&kInteractive.helpers.persister)if(kInteractive.helpers.persister.instances[t.id])kInteractive.helpers.persister.instances[t.id]instanceof kPersister&&kInteractive.helpers.persister.instances[t.id].restore();else{var I={storage:k.dataset.option,enabled:y,root:t,silentMode:void 0!==k.dataset.auto&&"true"==k.dataset.auto,delegateEvents:!1,messages:{save:r.save?r.save:"Save",unsaved:r.unsaved?r.unsaved:"You have unsaved changes",saving:r.saving?r.saving:"Saving ..",saved:r.saved?r.saved:"Changes has been saved!",dismiss:r.dismiss?r.dismiss:"dismiss",lastSaved:r.lastSaved?r.lastSaved:"Last saved on"}};Object.keys(k.dataset).some(function(e){return-1!=e.indexOf("design")})&&(I.design=function(e){var t={};e.designPlacement&&(t.placement=e.designPlacement);(e.designUnsavedColor||e.designUnsavedBackground)&&(t.unsaved={});e.designUnsavedColor&&(t.unsaved.color=e.designUnsavedColor);e.designUnsavedBackground&&(t.unsaved.background=e.designUnsavedBackground);(e.designSuccessColor||e.designSuccessBackground)&&(t.success={});e.designSuccessColor&&(t.success.color=e.designSuccessColor);e.designSuccessBackground&&(t.success.background=e.designSuccessBackground);return t}(k.dataset)),kInteractive.helpers.persister.addInstance(t.id,I),kInteractive.helpers.persister.instances[t.id].on("persister.ready",function(e){e.target.enabled&&e.target.restore()}),kInteractive.helpers.persister.instances[t.id].on("persister.restored",function(e){}),kInteractive.helpers.persister.instances[t.id].on("persister.error",function(e){}),kInteractive.helpers.persister.instances[t.id].on("persister.saved",function(e){}),kInteractive.helpers.persister.instances[t.id].on("persister.unsaved",function(e){}),kInteractive.helpers.persister.instances[t.id].on("persister.pushed",function(e){}),kInteractive.helpers.persister.instances[t.id].init()}}}}},action:function(f,t){var n=kInteractive.readData(f);if(n){var a=n.dict,i=n.userDict;if(a=a||{},i=i||a,n.layout&&n.layout.popup&&!kInteractive.hasClass(f,"inpopup")&&"img"==t.nodeName.toLowerCase()){function r(e){for(var t=0;e=e.previousSibling;)"#text"!=e.nodeName&&8!=e.nodeType&&t++;return t}var e=document.getElementById("epubContent");e&&f.setAttribute("data-loc",function(e,t){for(var n="";e!=t;){n=r(e)+"."+n,e=e.parentNode}return""==n?"":n.substr(0,n.length-1)}(f,e));var g=document.createElement("iframe");g.setAttribute("nwdisable","true"),g.setAttribute("nwfaketop","true"),g.setAttribute("scrolling","yes");var k=document.createElement("div");return k.className="scroller",k.appendChild(g),n.cb=function(e){var t,n=document.createElement("head");if("undefined"==typeof isKotobee){for(var a=document.getElementsByTagName("link"),i=0;i<a.length;i++){var r=a[i];if(0<=r.getAttribute("href").indexOf("base.css")){var s=r.getAttribute("href").split("/");delete s[s.length-1],t=s.join("/");break}}if(!t)return}var o="undefined"==typeof isKotobee?kInteractive.c.removeHash(window.location.href):kInteractive.absoluteURL;o=kInteractive.c.removeFilename(o)+"/",o=kInteractive.cleanURL(o),"undefined"!=typeof isKotobee&&desktop&&!kInteractive.isAbsolutePath(o)&&(o=kInteractive.c.removeFilename(kInteractive.c.removeHash(window.location.href))+"/"+o);for(var c=o.split("EPUB/xhtml")[1].split("/").length-1,l="",d=0;d<c;d++)l+="../";n="<head>";if(n+='<base href="'+o+'"/>',n+='<link rel="stylesheet" type="text/css" href="'+(l+"css/base.css")+'" />',n+='<link rel="stylesheet" type="text/css" href="'+(l+"css/global.css")+'" />',n+='<link rel="stylesheet" type="text/css" href="'+(l+"css/kotobeeInteractive.css")+'" />',n+='<script type="text/javascript" src="'+(l+"js/kotobeeInteractive.js")+'"><\/script>',n+='<script type="text/javascript" src="'+(l+"js/global.js")+'"><\/script>',"undefined"!=typeof isKotobee){var u=clone(config);u.kotobee.email=angular.element(document.body).scope().data.user.email,n+='<script type="text/javascript">var config='+JSON.stringify(u)+";<\/script>"}n+='<meta name="viewport" content="viewport-fit=cover,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,width=device-width">',n+='<meta charset="utf-8" />',n+="</head>";var v=f.outerHTML;v=(v=(v=(v=(v=(v=v.replace("<img",'<img style="display:none"')).replace(/([;\s]*?height:)(.*)?;/i,"$1auto")).replace(/([;\s]*?width:)(.*)?;/i,"$1auto")).replace(/([;\s]*?top:)(.*)?;/i,"$1auto")).replace(/([;\s]*?left:)(.*)?;/i,"$1auto")).replace('class="','class="inpopup ');var p="<html>"+n+"<body>"+(v+='<div class="vSpace20"></div>')+"</body></html>";g.setAttribute("srcdoc",p);var m="javascript: window.frameElement.getAttribute('srcdoc');";function h(){if("undefined"!=typeof isKotobee){var e={};e.root=g.contentDocument.documentElement.ownerDocument.body,e.rootIndex=f.getAttribute("data-loc"),angular.element(document.body).scope().getNotebookShortcut(e,function(){})}}g.setAttribute("src",m),g.contentWindow&&(g.contentWindow.location=m),e.appendChild(k),g.addEventListener?g.addEventListener("load",h,!0):g.attachEvent&&g.attachEvent("onload",h)},n.closed=function(){},n.pos=n.layout.pos,kInteractive.openFrame(n),kInteractive.tinCan({verb:"opened",activity:"Questions: "+n.title}),void setTimeout(function(){if(kInteractive.scorm){var e={};e.id=kInteractive.getScormId("question",n.title),e.description="Opened question popup: "+n.title,e.learnerResponses="Opened",e.type="other",e.timestamp=new Date,kInteractive.scorm.setInteractions([e])}kInteractive.events&&kInteractive.events.add({action:"questionPopup",param:n.title,elem:f,data:n})},800)}if(kInteractive.hasClass(t,"ki-inputbox"))kInteractive.helpers.persister.instances[f.id]&&kInteractive.helpers.persister.instances[f.id].handleChange();else if(kInteractive.hasClass(t,"ki-textfield"))kInteractive.helpers.persister.instances[f.id]&&kInteractive.helpers.persister.instances[f.id].handleChange();else if(kInteractive.hasClass(t,"ki-draggable"))kInteractive.helpers.persister.instances[f.id]&&kInteractive.helpers.persister.instances[f.id].handleChange();else if(!kInteractive.hasClass(t,"kInteractive")){if(kInteractive.hasClass(t,"questions-next")){var s=f.qIndex?f.qIndex:0;if(++s<0)return;if(s>=n.q.length)return;var o=(L=f.getElementsByClassName("qContainer")[0]).children[0];if(n.options.strictNav)if(!(D=kInteractive.questions.f.assess(o,n.q[s-1],n)).correct)return void kInteractive.questions.f.showExp(n.userDict,o,n.q[s-1]);f.getElementsByClassName("btnContainer")[0];return L.innerHTML="",L.appendChild(kInteractive.questions.f.createQElem(n,{index:s,elem:f,rendered:!0})),o&&(f.questions||(f.questions=[]),f.questions.push(o)),kInteractive.questions.f.showNavBtns(s,f,{userDict:i,qsData:n}),void(f.qIndex=s)}if(kInteractive.hasClass(t,"questions-prev")){if(!f.questions)return;if(!f.questions.length)return;s=f.qIndex?f.qIndex:0;return s--,(L=f.getElementsByClassName("qContainer")[0]).innerHTML="",L.appendChild(f.questions.pop()),kInteractive.questions.f.showNavBtns(s,f,{userDict:i,qsData:n}),void(f.qIndex=s)}if(kInteractive.hasClass(t,"questions-clear")){for(var c=f.getElementsByClassName("ans"),l=[],d=0;d<c.length;d++)c[d].checked=!1,c[d].value=null,kInteractive.c.removeClass(c[d].parentNode,"correct"),kInteractive.c.removeClass(c[d],"incorrect"),kInteractive.c.hasClass(c[d].parentNode,"dCategory")&&l.push(c[d]);for(d=0;d<l.length;d++)l[d].parentNode.parentNode.parentNode.getElementsByClassName("ki-dd-answers")[0].appendChild(l[d]);var u=f.getElementsByClassName("explanation");for(d=u.length;d--;)u[d].parentNode.removeChild(u[d]);var v=f.getElementsByClassName("reference");for(d=v.length;d--;)v[d].parentNode.removeChild(v[d]);return document[f.id]=null,void(kInteractive.helpers.persister.instances&&kInteractive.helpers.persister.instances[f.id].clear())}if(kInteractive.hasClass(t,"questions-notebook")){var p,m=n.layout&&n.layout.popup&&kInteractive.hasClass(f,"inpopup");if("undefined"==typeof isKotobee&&!m)return void kInteractive.alert({content:a.kotobeeOnly,title:i.sorry?i.sorry:"Sorry"});var h={elem:f};if("undefined"!=typeof isKotobee)p=angular.element(document.body).scope();else{try{p=window.parent.getGlobal()}catch(e){return void kInteractive.alert({content:a.kotobeeOnly,title:i.sorry?i.sorry:"Sorry"})}h.rootIndex=f.getAttribute("data-loc"),h.root=f}return kInteractive.c.addClass(t,"busy"),void p.questionsAddToNotebookShortcut(h,function(){kInteractive.c.removeClass(t,"busy"),kInteractive.alert({content:i.savedToNotebook?i.savedToNotebook:"Saved to notebook!"})})}if(kInteractive.hasClass(t,"questions-preserve")){if(document[f.id]||(document[f.id]={}),document[f.id].preserve=t.checked,kInteractive.helpers.persister.instances){var b="persist-"+kInteractive.getBookID()+"-"+f.id;t.checked?(sessionStorage.setItem(b,"true"),kInteractive.helpers.persister.instances[f.id].enable(void 0!==t.dataset.auto&&"true"==t.dataset.auto)):(sessionStorage.setItem(b,"false"),kInteractive.helpers.persister.instances[f.id].disable())}}else if(kInteractive.hasClass(t,"questions-submit")){var y="Untitled questions",I=f.getElementsByTagName("h4");I.length&&(y=I[0].textContent||I[0].data);var C,E=0,w="",x=0,N=0,A=[];if("slides"==n.options.displayMode){C=f.questions.slice(0);var L=f.getElementsByClassName("qContainer")[0];C.push(L.children[0])}else C=f.getElementsByClassName("ques");var T=0;for(d=0;d<C.length;d++)if(!kInteractive.hasClass(C[d],"sp")){T++;var S=0<(c=C[d].getElementsByClassName("ans")).length,B=n.q[d];if(n.options.randomize&&(B=n.q[Number(C[d].getAttribute("data-o"))]),B.q||(B.q=""),B.q=B.q.replace(/<html.*<body>(.*?)<\/body><\/html>/g,"$1"),kInteractive.scorm&&n.options&&n.options.answerOnce&&kInteractive.scorm.interactionExists(kInteractive.getScormId(f.id+"-"+T,B.q))){var q="<p style='text-align:center'>"+(i.alreadySubmitted?i.alreadySubmitted:"This test has already been submitted!")+"</p>";return void kInteractive.alert({content:q})}var R={},M=c[0].getAttribute("id");A.push(R),R.id=kInteractive.getScormId(f.id+"-"+T,B.q),R.qid=f.id,0<=M.indexOf("ki-tf-")?R.type="true-false":0<=M.indexOf("ki-mcq-")||M.indexOf("ki-mmcq-")?R.type="choice":0<=M.indexOf("ki-dd-")?R.type="drag-drop":0<=M.indexOf("ki-sa-")&&(R.type="short-answer"),R.objective=n.options?n.options.objective:null,R.timestamp=kInteractive.timestamp,R.latency=Math.round(((new Date).getTime()-kInteractive.timestamp.getTime())/1e3),R.description=B.q;var D,O=[];(D=kInteractive.questions.f.assess(C[d],B,n)).correctResponses&&(R.correctResponses=D.correctResponses),D.learnerResponses&&(R.learnerResponses=D.learnerResponses),O=(O=D.ddInteractionOb)||[];S=D.correct;if(O.length)for(var H=0;H<O.length;H++)R.correctResponses&&(R.correctResponses+="; "),R.learnerResponses&&(R.learnerResponses+="; "),R.correctResponses+=O[H].correct,R.learnerResponses+=O[H].learner;R.result=0,null!=B.weight&&(x+=+B.weight,S&&(N+=+B.weight,R.result=+B.weight)),R.scoreMax=n.options?Number(n.options.totalScore):null,kInteractive.questions.f.showExp(n.userDict,C[d],B);var F=document.createElement("div");F.innerHTML=B.q.replace(/'/g,"&#39;");var P=F.textContent,U=i.question?i.question.replace("[no]",T):"Question "+T;S?(w+="<span style='border-bottom: dotted 1px #aaa;' title='"+P+"'>"+U+".</span>  <span style='color:#366c20'>"+i.correct+"</span><br/>",E++):w+="<span style='border-bottom: dotted 1px #aaa;' title='"+P+"'>"+U+".</span>  <span style='color:#7a1818'>"+i.incorrect+"</span><br/>"}for(d=0;d<A.length;d++)A[d].weighting=Math.round(1e3*n.options.totalScore/x)/1e3;function j(){var e="Questions: "+y+". Score: "+E+" questions out of "+T;e+=". Action: "+z,"selfAnswerReport"==z&&(e+=". Details: "+w),kInteractive.tinCan({verb:"solved",activity:e})}var K,z=n.action;if(n.options.totalScore&&x&&(K=Math.round(10*n.options.totalScore*N/x)/10),"selfAnswer"==z||"selfAnswerReport"==z){var W="";"ar"==n.options.language&&(W=' direction="rtl"');q="";if(i.scoreWeight){if(null!=K){var J="";n.options.passScore&&(K>=n.options.passScore||K==n.options.totalScore?J+=i.pass:J+=i.fail),J&&(J+=". "),q+="<h3"+W+">"+(J||"")+i.scoreWeight.replace("[score]",K).replace("[total]",n.options.totalScore)+"</h3>"}q+="<p"+W+">"+i.score.replace("[correct]",E).replace("[total]",T)+"</p>"}else q="You scored "+E+" question(s) out of "+T;"selfAnswerReport"==z&&(q="<p"+W+"><strong>"+q+"</strong></p><p><strong>"+(i.details?i.details:"Details")+"</strong></p><p class='kbAlertScroll'>"+w+"</p>"),kInteractive.alert({content:q}),j()}if("email"==z||n.options.reportEmail||n.options.emailForm){var _="selfAnswer"!=z&&"selfAnswerReport"!=z&&"email"!=z;try{if(!config.kotobee.cloudid)return void(_&&kInteractive.alert({content:a.cloudOnly,title:i.sorry?i.sorry:"Sorry"}))}catch(e){return void(_&&kInteractive.alert({content:a.cloudOnly,title:i.sorry?i.sorry:"Sorry"}))}var G={};G.ans=new Array;for(var V=0;V<C.length;V++)for(c=C[V].getElementsByClassName("ans"),d=0;d<c.length;d++)c[d].checked&&G.ans.push({q:V,index:d,label:c[d].nextSibling.textContent||c[d].nextSibling.data});G.title=y;var Q={};if(Q.recipient=n.address,n.options.reportEmail&&(Q.recipient=n.options.reportEmail),Q.content=JSON.stringify(G),Q.mode=config.kotobee.mode,Q.cloudid=config.kotobee.cloudid,Q.email=config.kotobee.email?config.kotobee.email:angular.element(document.body).scope().data.user.email,n.options.emailForm){var Y=document.getElementsByName("recipientEmail");Y.length&&(Q.recipient=Q.recipient?Q.recipient+","+Y[0].value:Y[0].value)}var X=t.value;t.value=i.submitting?i.submitting:"Submitting ..",t.setAttribute("disabled","true");var $=new XMLHttpRequest;$.onreadystatechange=function(){try{if(4===$.readyState&&200===$.status){if(t.value=X,t.removeAttribute("disabled"),!_)return;JSON.parse($.responseText).success?kInteractive.alert({content:i.submitted?i.submitted:"Answers submitted!"}):kInteractive.alert({content:i.errorSubmitting?i.errorSubmitting:"An error has occurred while sending answers to the server"})}}catch(e){if(t.value=X,t.setAttribute("value",t.value),t.removeAttribute("disabled"),!_)return;kInteractive.alert({content:i.errorSubmitting?i.errorSubmitting:"An error has occurred while sending answers to the server"})}};var Z=config.kotobee.liburl?config.kotobee.liburl:"http://www.kotobee.com/";Z+="library/report/questions",$.open("POST",Z),$.setRequestHeader("Content-type","application/x-www-form-urlencoded");var ee="a=a";for(var te in Q){var ne;null!=(ne=Q[te])&&"object"!=typeof ne&&("string"==typeof ne&&(ne=encodeURIComponent(ne)),"boolean"==typeof ne&&(ne=ne?1:0),ee+="&"+te+"="+ne)}$.send(ee),j()}document[f.id]||(document[f.id]={}),document[f.id].q=[];var ae=f.getElementsByClassName("ques");for(V=0;V<ae.length;V++){var ie=V;n.options.randomize&&(ie=Number(ae[V].getAttribute("data-o"))),document[f.id].q[ie]=[];var re=ae[V].getElementsByClassName("ans");for(d=0;d<re.length;d++)kInteractive.hasClass(re[d],"txtfield")?document[f.id].q[ie][d]=re[d].value:re[d].type&&"checkbox"==re[d].type.toLowerCase()?document[f.id].q[ie][d]=re[d].checked:re[d].type&&"radio"==re[d].type.toLowerCase()?document[f.id].q[ie][d]=re[d].checked:kInteractive.c.hasClass(re[d].parentNode,"dCategory")&&(document[f.id].q[ie][d]={id:re[d].id,category:kInteractive.getChildIndex(re[d].parentNode)})}setTimeout(function(){kInteractive.scorm&&kInteractive.scorm.setInteractions(A),kInteractive.events&&kInteractive.events.add({action:"questionsSubmitted",param:y,elem:f,data:n})},500)}}}},f:{showExp:function(e,t,n){if(n.exp&&!t.getElementsByClassName("explanation").length){var a=document.createElement("p");a.className="explanation",a.innerHTML=kInteractive.escapeHtml(n.exp),kInteractive.appendAfterDelay(t,a)}if(n.ref&&!t.getElementsByClassName("reference").length){var i=document.createElement("a");i.className="reference",i.innerHTML=e.learnMode?e.learnMode:"Learn more",i.setAttribute("href",kInteractive.escapeHtml(n.ref)),i.setAttribute("target","_blank"),kInteractive.appendAfterDelay(t,i)}},createQElem:function(e,t){var n=(t=t||{}).index,a=t.elem,i=t.rendered,r=this.getQId(a),s=e.q[n],o=document.createElement("div");o.className="ques",null!=s.origin&&o.setAttribute("data-o",s.origin),s.q||(s.q="");"undefined"!=typeof config&&config.v;var c=e.options.numbering;"sp"==s.type&&(c=!1),s.q=s.q.replace(/<html.*<body>(.*?)<\/body><\/html>/g,"$1");try{o.innerHTML="<div class='questionTxt'><strong>"+(c?"<span class='no'>"+(n+1)+"</span>":"")+"</strong> "+s.q+"</div>"}catch(e){o.innerHTML="<div class='questionTxt'><strong>"+(c?"<span class='no'>"+(n+1)+"</span>":"")+kInteractive.escapeHtml(" "+s.q)+"</strong></div>"}if(s.path){var l,d=document.createElement("img");l=i?"undefined"==typeof isKotobee?s.path:ph.join(kInteractive.absoluteURL,s.path):s.path,d.src=kInteractive.cleanURL(l),d.className=typeof isKotobee,o.appendChild(d)}if(o.classList.add(s.type),"sp"==s.type&&(s.topBorder&&kInteractive.c.addClass(o,"topBorder"),s.bottomBorder&&kInteractive.c.addClass(o,"bottomBorder"),kInteractive.c.addClass(o,"separator")),"sa"==s.type){var u=s.lines?s.lines:1,v=document.createElement(1<u?"textarea":"input"),p="ki-sa-"+r+"-"+n;v.id=p,v.name="sa-"+r+"-"+n,1==u?v.type="text":v.rows=s.lines?s.lines:1,v.className="ki-textfield ans txtfield","undefined"==typeof isKotobee&&(v.addEventListener("keyup",kInteractive.actionEvent),v.addEventListener("change",kInteractive.actionEvent)),document[item.id]&&document[item.id].preserve&&document[item.id].q&&document[item.id].q[n]&&(v.value=document[item.id].q[n]),o.appendChild(v)}else if("mcq"==s.type||"mmcq"==s.type)for(var m=s.c,h=0;h<m.length;h++){p="ki-mcq-"+r+"-"+n+"-"+h;var f=document.createElement("input");f.id=p,"mmcq"==s.type?(f.name="name",f.type="checkbox"):(f.name="mcq-"+r+"-"+n,f.type="radio"),f.className="ki-inputbox ans","undefined"==typeof isKotobee&&f.addEventListener("click",kInteractive.actionEvent),(g=document.createElement("label")).htmlFor=p,g.innerHTML=" "+kInteractive.escapeHtml(m[h].t),g.className="ki-noHighlight",(b=document.createElement("div")).className="answer",document[item.id]&&document[item.id].preserve&&document[item.id].q&&document[item.id].q[n]&&(f.checked=document[item.id].q[n][h],e.options&&e.options.highlightCorrect&&s.c[h].a&&kInteractive.c.addClass(b,"correct")),b.appendChild(f),b.appendChild(g),o.appendChild(b)}else if("tf"==s.type)for(h=0;h<2;h++){p="ki-tf-"+r+"-"+n+"-"+h;var g,k=document.createElement("input");k.type="radio",k.className="ki-inputbox ans",k.id=p,k.name="tf-"+r+"-"+n,"undefined"==typeof isKotobee&&k.addEventListener("click",kInteractive.actionEvent),(g=document.createElement("label")).htmlFor=p,s.choice1&&s.choice2?g.innerHTML=kInteractive.escapeHtml(" "+(0==h?s.choice1:s.choice2)):g.innerHTML=" "+(0==h?"True":"False"),g.className="ki-noHighlight";var b=document.createElement("div");document[item.id]&&document[item.id].preserve&&document[item.id].q&&document[item.id].q[n]&&(k.checked=document[item.id].q[n][h],e.options&&e.options.highlightCorrect&&(0==h&&s.a||1==h&&!s.a)&&kInteractive.c.addClass(b,"correct")),b.appendChild(k),b.appendChild(g),o.appendChild(b)}else if("dd"==s.type){var y=document.createElement("div");y.className="categoryContainer";var I=[];for(h=0;h<s.k.length;h++){var C=s.k[h],E=h,w=document.createElement("div");w.className="dCategory ki-noHighlight ki-dd-category-"+E,w.setAttribute("ondragover","kInteractive.allowDrop(event)"),w.setAttribute("ondrop","kInteractive.drop(event)");var x=document.createElement("div");x.innerHTML=C.category.name,x.className="qTitle",w.appendChild(x);for(var N=0;N<C.category.answers.length;N++)I.push(C.category.answers[N].t);y.appendChild(w)}o.appendChild(y);var A=document.createElement("div");A.className="ki-dd-clearfix",o.appendChild(A);var L=document.createElement("div");L.setAttribute("ondragover","kInteractive.allowDrop(event)"),L.setAttribute("ondrop","kInteractive.drop(event)"),L.className="ki-dd-answers ki-noHighlight";var T=[];for(h=0;h<I.length;h++){E=h,b=I[h];var S=document.createElement("div");p="ki-dd-"+r+"-"+n+"-"+E;S.id=p,S.innerHTML="<span></span>",S.children[0].innerText=b,S.className="ki-draggable ans ki-noHighlight",S.draggable=!0,S.setAttribute("ondragstart","kInteractive.drag(event)"),"undefined"==typeof isKotobee&&S.addEventListener("dragend",kInteractive.actionEvent),T.push(S)}kInteractive.shuffleArray(T);for(h=0;h<T.length;h++)L.appendChild(T[h]);o.appendChild(L)}var B=document.createElement("p");return B.className="separator",o.appendChild(B),document[item.id]&&document[item.id].preserve&&document[item.id].q&&document[item.id].q[n]&&kInteractive.questions.f.showExp(e.userDict,o,s),o},getQId:function(e){return Number(e.id.replace("ki-qs-",""))},createSubmitBtn:function(e,t){var n=this.getQId(t),a=document.createElement("input"),i="ki-"+n+"-btn";return a.type="submit",a.value=e.submit?e.submit:"Submit Answers",a.id=i,a.className="btn ki-btn questions-submit","undefined"==typeof isKotobee&&a.addEventListener("click",kInteractive.actionEvent),a},createClearBtn:function(e){var t=document.createElement("input");return t.type="submit",t.value=e.clear?e.clear:"Clear Answers",t.className="btn ki-btn ki-questions questions-clear","undefined"==typeof isKotobee&&t.addEventListener("click",kInteractive.actionEvent),t},createAddToNotebookBtn:function(e){var t=document.createElement("input");return t.type="submit",t.value=e.notebook?e.notebook:"Save to Notebook",t.className="btn ki-btn ki-questions questions-notebook","undefined"==typeof isKotobee&&t.addEventListener("click",kInteractive.actionEvent),t},createPreserveBtn:function(e,t,n,a){var i=this.getQId(t),r=document.createElement("div");r.style.marginTop="5px";var s=document.createElement("input");function o(e){return e.slice(0,1).toUpperCase()+e.slice(1)}s.type="checkbox",s.name="preserveAnswers",s.className="ki-btn ki-questions questions-preserve",s.id="ki-"+i+"-preserveAnswersBtn",n&&a&&(s.dataset.option=n.option,0<Object.keys(a).length&&Object.keys(a).forEach(function(t){"placement"==t?s.dataset["design"+o(t)]=a[t]:Object.entries(a[t]).forEach(function(e){s.dataset["design"+o(t)+o(e[0])]=e[1]})}),n.auto?(s.dataset.auto=n.auto,r.style.display="none"):"undefined"!=typeof isKotobee&&document.body.addEventListener("change",function(e){e.target.matches("input.questions-preserve")&&kInteractive.actionEvent(e)})),document[item.id]&&(s.checked=document[item.id].preserve),r.appendChild(s);var c=document.createElement("label");return c.htmlFor=s.id,c.innerHTML=" "+(e.preserve?e.preserve:"Preserve submitted answers"),c.className="ki-noHighlight",r.appendChild(c),"undefined"==typeof isKotobee&&s.addEventListener("change",kInteractive.actionEvent),r},createNextBtn:function(e){var t=document.createElement("input");return t.type="submit",t.value=e.next?e.next:"Next",t.className="btn ki-btn ki-questions questions-next","undefined"==typeof isKotobee&&t.addEventListener("click",kInteractive.actionEvent),t},createPrevBtn:function(e){var t=document.createElement("input");return t.type="submit",t.value=e.prev?e.prev:"Previous",t.className="btn ki-btn ki-questions questions-prev","undefined"==typeof isKotobee&&t.addEventListener("click",kInteractive.actionEvent),t},createSeparator:function(){document.createElement("p").className="separator"},createEmailForm:function(e){var s=document.createElement("div");return s.setAttribute("class","emailForm"),function(e,t,n){var a=document.createElement("div");a.className="address",a.innerHTML="<p><strong>"+e+"</strong><em>"+t+"</em></p>";var i=document.createElement("input");i.name=n,i.type="text",i.className="txtfield",a.appendChild(i);var r=document.createElement("p");r.className="separator",a.appendChild(r),s.appendChild(a)}(e.recipientEmail?e.recipientEmail:"Recipient email",e.separateEmails?e.separateEmails:"Separate multiple emails with commas","recipientEmail"),s},showNavBtns:function(e,t,n){var a;(a=(n=n||{}).isFrag?t.lastElementChild:t.getElementsByClassName("btnContainer")[0]).innerHTML="";var i=kInteractive.questions.f.createPrevBtn(n.userDict);a.appendChild(i),e<=0&&i.classList.add("disabled");var r=kInteractive.questions.f.createNextBtn(n.userDict);if(a.appendChild(r),e>=n.qsData.q.length-1&&r.classList.add("disabled"),e==n.qsData.q.length-1){var s=kInteractive.questions.f.createSubmitBtn(n.userDict,t);s.classList.add("shift"),a.appendChild(s)}},assess:function(e,t,n){for(var a={ddInteractionOb:[]},i=e.getElementsByClassName("ans"),r=0<i.length,s=0;s<i.length;s++)if(0<=i[s].getAttribute("id").indexOf("ki-tf-"))0==s&&t.a?a.correctResponses=t.choice1:1!=s||t.a||(a.correctResponses=t.choice2),i[s].checked?(a.learnerResponses=s?t.choice2:t.choice1,0!=s||t.a?1==s&&t.a&&(r=!1):r=!1):0==s&&t.a?r=!1:1!=s||t.a||(r=!1),n.options&&n.options.highlightCorrect&&(0==s&&t.a||1==s&&!t.a)&&kInteractive.c.addClass(i[s].parentNode,"correct");else if(0<=i[s].getAttribute("id").indexOf("ki-sa-")){var o=i[s].value.toLowerCase();o=o&&o.trim(),r=!0;for(var c="",l=0;l<t.k.length;l++){var d=t.k[l].t;if(!d){r=!1;break}c&&(c+="+"),c+=d=d.toLowerCase();for(var u=d.split(","),v=!1,p=0;p<u.length;p++)if(0<=o.indexOf(u[p].trim())){v=!0;break}if(!v){r=!1;break}}a.correctResponses=c,a.learnerResponses=o}else if(0<=i[s].getAttribute("id").indexOf("ki-dd-")){kInteractive.c.removeClass(i[s],"incorrect");for(var m,h=i[s].id.split("-")[4],f=0,g=0;g<t.k.length;g++){if(h<(f+=t.k[g].category.answers.length)){m=g;break}}var k=e.getElementsByClassName("dCategory")[m],b={};if(b.correct=i[s].innerText+" -> "+k.children[0].innerText,kInteractive.c.hasClass(i[s].parentNode,"ki-dd-answers"))kInteractive.c.addClass(i[s],"incorrect"),r=!1,b.learner=i[s].innerText+" unassigned";else{var y=i[s].parentNode,I=y.children[0].innerText,C=kInteractive.getChildIndex(y);b.learner=i[s].innerText+" -> "+I,C!=m&&n.options&&n.options.highlightCorrect&&(r=!1,kInteractive.c.addClass(i[s],"incorrect"))}a.ddInteractionOb.push(b)}else t.c[s].a&&(a.correctResponses=t.c[s].t),i[s].checked&&(a.learnerResponses=t.c[s].t),i[s].checked&&!t.c[s].a?r=!1:!i[s].checked&&t.c[s].a&&(r=!1),n.options&&n.options.highlightCorrect&&t.c[s].a&&kInteractive.c.addClass(i[s].parentNode,"correct");return a.correct=r,a}}},kInteractive.threed={preRender:function(e,t){},postRender:function(e,t,n,a){var i=e.createDocumentFragment(),r=kInteractive.readData(t);if(r){t.innerHTML="";var s=t.getAttribute("style");if(r.inter.placeholderPath){var o="undefined"==typeof isKotobee?r.inter.placeholderPath:ph.join(kInteractive.absoluteURL,r.inter.placeholderPath);s+="background-image:url('"+(o=kInteractive.cleanURL(o))+"');"}t.setAttribute("style",s);var c=document.createElement("a");r.inter.includeMsg?(c.innerHTML=kInteractive.escapeHtml(r.inter.msg),c.className="msgBtn ki-btn"):c.className="invisibleBtn ki-btn",i.appendChild(c),"undefined"==typeof isKotobee&&c&&c.addEventListener("click",kInteractive.actionEvent),t.appendChild(i)}},action:function(f,e,t){var g=kInteractive.readData(f);if(g){"inPanel"==g.inter.target?kInteractive.c.addClass(f,"running"):f.innerHTML="";var k=document.createElement("div");if(k.className="loading",f.appendChild(k),"undefined"==typeof THREE){var n,a=document.getElementsByTagName("head")[0],i=a.getElementsByTagName("script");if("undefined"!=typeof isKotobee)n=bookPath+"EPUB/js/kotobeeInteractive3D.js";else for(var r=0;r<i.length;r++)if(0<=i[r].src.indexOf("kotobeeinteractive.js")){n=i[r].src.replace("kotobeeinteractive.js","kotobeeinteractive3D.js");break}if(!n)return;var s=document.createElement("script");s.type="text/javascript",s.src=n,s.onload=o,s.onreadystatechange=function(){"complete"==this.readyState&&o()},a.appendChild(s)}else o()}function o(){var h,e=f;if("inPanel"==g.inter.target){var t={class:"threed",cb:function(e){var t=document.createElement("div");t.className="container",e.appendChild(t),n(t)},closed:function(){kInteractive.c.removeClass(f,"running")}};kInteractive.openFrame(t)}else n(e);function n(t){var n;setTimeout(function(){if(kInteractive.scorm){var e={};e.id=kInteractive.getScormId("_3D",g.name?g.name:"Model"),e.description="Opened 3D model: "+(g.name?g.name:"No name"),e.learnerResponses="Viewed",e.type="other",e.timestamp=new Date,kInteractive.scorm.setInteractions([e])}kInteractive.events&&kInteractive.events.add({action:"3dModelViewed",param:g.name?g.name:"No name",elem:f,data:g})},800),h&&cancelAnimationFrame(h),n=function(){try{var e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return!1}}()?new THREE.WebGLRenderer({precision:"highp"}):new THREE.CanvasRenderer;var e=t.offsetWidth,a=t.offsetHeight,i=new THREE.PerspectiveCamera(g.camera.viewAngle,e/a,g.camera.near,g.camera.far),c=new THREE.Scene;null!=g.scene.bgColor&&n.setClearColor(g.scene.bgColor,1),c.add(i),i.position.x=g.camera.x,i.position.y=g.camera.y,i.position.z=g.camera.z,n.setSize(e,a),g.scene.floor&&(floor=new THREE.Mesh(new THREE.PlaneGeometry(500,500,1,1),new THREE.MeshPhongMaterial({color:g.scene.floorColor?g.scene.floorColor:10066329})),floor.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),floor.position.y=-80,floor.receiveShadow=!0,c.add(floor));var l=new THREE.LoadingManager;l.onProgress=function(e,t,n){},function r(s){if(!(s>=g.objects.length)){var o=g.objects[s],e="undefined"==typeof isKotobee?o.path:ph.join(kInteractive.absoluteURL,o.path);e=kInteractive.cleanURL(e),new THREE.OBJLoader(l).load(e,function(i){k&&k.parentNode&&k.parentNode.removeChild(k),n.domElement.parentNode||t.appendChild(n.domElement),i.position.set(o.x,o.y,o.z),i.traverse(function(n){if(n instanceof THREE.Mesh){var a=n==i.children[i.children.length-1];if(o.textPath){var e=new THREE.ImageLoader(l),t="undefined"==typeof isKotobee?o.textPath:ph.join(kInteractive.absoluteURL,o.textPath);e.load(t,function(e){var t=new THREE.Texture;t.image=e,t.needsUpdate=!0,n.material.map=t,a&&c.add(i),r(++s)},function(){},function(e){})}else a&&c.add(i),r(++s)}})},function(e){e.lengthComputable&&(e.loaded,e.total)},function(e){})}}(0),new THREE.OrbitControls(i,n.domElement).target=new THREE.Vector3(0,0,0);for(var r=0;r<g.lights.length;r++)if("pointLight"==g.lights[r].type){var s=new THREE.PointLight(g.lights[r].color);s.position.set(g.lights[r].x,g.lights[r].y,g.lights[r].z),c.add(s)}else if("directionalLight"==g.lights[r].type){var o=new THREE.DirectionalLight(g.lights[r].color,g.lights[r].intensity);o.position.set(g.lights[r].x,g.lights[r].y,g.lights[r].z),c.add(o)}else if("hemisphereLight"==g.lights[r].type){var d=new THREE.HemisphereLight(g.lights[r].sky,g.lights[r].ground,g.lights[r].intensity);d.position.set(g.lights[r].x,g.lights[r].y,g.lights[r].z),c.add(d)}else if("spotLight"==g.lights[r].type){var u=new THREE.SpotLight(g.lights[r].color,g.lights[r].intensity,g.lights[r].distance,g.lights[r].angle,g.lights[r].exponent,g.lights[r].decay);u.position.set(g.lights[r].x,g.lights[r].y,g.lights[r].z),c.add(u)}else if("ambientLight"==g.lights[r].type){var v=new THREE.AmbientLight(g.lights[r].color);c.add(v)}else if("areaLight"==g.lights[r].type){var p=new THREE.AreaLight(g.lights[r].color,g.lights[r].intensity);c.add(p)}var m=new THREE.Clock;!function e(){try{n.render(c,i)}catch(e){return}m.getDelta();h=requestAnimFrame(e)}()}}}},kInteractive.video={preRender:function(e,t){},postRender:function(e,t,n){var a=e.createDocumentFragment(),i=kInteractive.readData(t);if(i){var r="";if(i.splash&&(r="undefined"==typeof isKotobee?i.splash:ph.join(kInteractive.absoluteURL,i.splash)),r){t.style.backgroundImage=null;var s=t.style.cssText;r=kInteractive.cleanURL(r),t.setAttribute("style","background-image:url('"+r+"');"+s)}t.setAttribute("id","ki-video-"+n),t.innerHTML="";var o=document.createElement("div");o.setAttribute("id","ki-video-"+n+"-container"),o.className="container";var c=document.createElement("div");i.style&&kInteractive.c.addClass(c,i.style);var l=document.createElement("a");l.className="playBtn ki-btn",l.appendChild(document.createElement("span")),"undefined"==typeof isKotobee&&l.addEventListener("click",kInteractive.actionEvent),a.appendChild(l),a.appendChild(o),c.appendChild(a),t.appendChild(c),i.autoplay&&kInteractive.action(t)}},action:function(s){var o=kInteractive.readData(s);if(o){if(o.popup&&"kInteractiveFrame"!=s.parentNode.id){var e={pos:"side",aspectRatio:"16:9",cb:function(e){var t=document.createElement("div");t.innerHTML=s.outerHTML;var n=t.children[0];n.style.width="100%",n.style.height="100%",n.style.margin="0",n.style.position="absolute",n.style.left=0,n.style.top=0,kInteractive.c.removeClass(n,"kbHidden"),e.appendChild(n);var a=s.id.split("ki-video-")[1];kInteractive.postRender(document,n,a),setTimeout(function(){kInteractive.action(n)},100)}};return kInteractive.openFrame(e)}var t=s.getAttribute("id")+"-container",c=s.getElementsByClassName("playBtn")[0];if(!(0<=c.className.indexOf("loading"))){if(kInteractive.stopCurrentMedia(),c.className="playBtn ki-btn loading",o.autoplay&&(c.className="playBtn ki-btn hide"),kInteractive.scorm){var n={};n.id=kInteractive.getScormId(s.getAttribute("id"),o.src),n.description="Played video: "+o.src,n.type="other",n.learnerResponses="Played",n.objective=o.options?o.options.objective:null,n.timestamp=new Date,kInteractive.scorm.setInteractions([n])}if(kInteractive.events&&kInteractive.events.add({action:"videoPlayed",param:o.src,elem:s,data:o}),"file"==o.type){u("undefined"==typeof isKotobee?o.video:ph.join(kInteractive.absoluteURL,o.video))}else{var a,i=new URL(o.src);if(i.origin.includes("youtube.com")||i.origin.includes("youtu.be")){if(!(a=i.origin.includes("youtube.com")?i.searchParams.get("v"):i.pathname.split("/")[1]))return;if(window&&window.iBooks)return setTimeout(function(){c.className="playBtn ki-btn"},1500),void(window.location.href=o.src);var r={videoId:a,playerVars:{autoplay:1,rel:"0"},events:{onReady:function(){},onStateChange:function(e){e.data==YT.PlayerState.PLAYING&&kInteractive.tinCan({verb:"played",activity:"Video: "+o.src})}}};if(kInteractive.youTubeStatus)if("loading"==kInteractive.youTubeStatus){if(kInteractive.vQueue)return;kInteractive.vQueue=function(){c.className="playBtn ki-btn hide",new YT.Player(t,r)}}else"ready"==kInteractive.youTubeStatus&&(c.className="playBtn ki-btn hide",new YT.Player(t,r));else{window.onYouTubePlayerAPIReady=function(){kInteractive.youTubeStatus="ready",kInteractive.vQueue(),kInteractive.vQueue=null};var l=document.createElement("script");l.src="https://www.youtube.com/player_api";var d=document.getElementsByTagName("script")[0];d.parentNode.insertBefore(l,d),kInteractive.youTubeStatus="loading",kInteractive.vQueue=function(){c.className="playBtn ki-btn hide",new YT.Player(t,r)}}}else u(o.src)}kInteractive.currentVideo=s,kInteractive.c.addClass(kInteractive.currentVideo,"playing")}}function u(e){var t,n=document.createElement("video");n.setAttribute("width","100%"),n.setAttribute("height","100%"),n.setAttribute("src",kInteractive.cleanURL(e)),n.setAttribute("autoplay","true"),n.setAttribute("data-tap-disabled","false"),0!=e.indexOf("http://")&&0!=e.indexOf("https://")||(t=!0),t&&n.setAttribute("crossorigin","anonymous");var a=!1;try{a=-1<navigator.userAgent.toLowerCase().indexOf("android")}catch(e){}a||n.setAttribute("type","video/mp4"),n.setAttribute("webkit-playsinline","true"),n.setAttribute("controls","true");var i="";o.splash&&(i="undefined"==typeof isKotobee?o.splash:ph.join(kInteractive.absoluteURL,o.splash)),i&&n.setAttribute("poster",kInteractive.cleanURL(i)),n.className="ki-noHighlight",o.hideDownloadBtn&&(n.className+=" hideDownloadBtn"),n.innerHTML="Your browser doesn't support HTML5 video.",t&&(n.crossOrigin="anonymous"),n.oncanplay=function(){kInteractive.currentVideo==s&&(c.className="playBtn ki-btn hide",kInteractive.tinCan({verb:"played",activity:"Video: "+e}))},n.addEventListener("error",function(e){e.target.error&&kInteractive.stopCurrentMedia()}),n.addEventListener("webkitfullscreenchange",function(e){var t=null!==document.webkitFullscreenElement;kInteractive.videoIsFullscreen=t});var r=s.getElementsByClassName("container")[0];r.setAttribute("data-tap-disabled","true"),r.appendChild(n)}},resize:function(e){var t=kInteractive.readData(e);t&&(kInteractive.checkResponsiveFloat(t,e),t.maintainRatio&&"px"==t.widthUnit&&t.height&&t.width&&"absolute"!=e.style.position&&(e.style.height=e.offsetWidth*(t.height/t.width)+"px"))}},kInteractive.widget={preRender:function(e,t){},postRender:function(e,t,n,a){a=a||{};var i=e.createDocumentFragment(),r=kInteractive.readData(t);if(r){var s=r.name,o=(r.src,r.width),c=r.height;if("page"==r.mode){if(t.children.length)return;var l=document.createElement("div");l.className="cover",i.appendChild(l),r.interaction&&(l.style.pointerEvents="none");var d=document.createElement("div");d.className="iframeContainer";var u=document.createElement("iframe");if(u.setAttribute("nwdisable","true"),u.setAttribute("nwfaketop","true"),u.setAttribute("sandbox","allow-same-origin allow-scripts allow-forms allow-modals"),u.setAttribute("width",t.style.width?t.style.width:o+r.widthUnit),u.setAttribute("height",t.style.height?t.style.height:c+"px"),u.src=kInteractive.getWidgetUrl(r,a),"undefined"!=typeof kotobee&&-1!==u.src.indexOf(".amazonaws.com")){var v=document.createElement("a");v.href=u.src,u.addEventListener("load",function(e){e.target.contentWindow.postMessage({user:{name:kotobee.user.name?kotobee.user.name:"",email:kotobee.user.email?kotobee.user.email:"",loggedIn:kotobee.user.loggedIn},book:kotobee.book.meta.dc.identifier,chapter:kotobee.currentChapter.url.split("EPUB/xhtml/")[1]},v.protocol+"//"+v.hostname)})}d.appendChild(u),i.appendChild(d);var p=t.style.width,m=t.style.height;0<=p.indexOf("px")&&(r.widthUnit="px"),0<=p.indexOf("%")&&(r.widthUnit="%");try{r.widthUnit?r.width=Number(p.split(r.widthUnit)[0]):r.width=Number(p)}catch(e){r.width=Number(p)}try{r.height=Number(m.split("px")[0])}catch(e){r.height=Number(m)}kInteractive.writeData(t,r)}else{if(!t.children.length&&!t.innerHTML.trim()){var h=document.createElement("img");h.src=kInteractive.getWidgetHome(r,a)+"/"+s+"/Icon.png?c="+Math.round(9999*Math.random()),h.className="wdgtIcon",i.appendChild(h)}"undefined"==typeof isKotobee&&t.addEventListener("click",kInteractive.actionEvent)}t.appendChild(i)}},action:function(t){var n=kInteractive.readData(t);if(n){var a=kInteractive.getWidgetUrl(n),i=document.createElement("iframe");i.setAttribute("nwdisable","true"),i.setAttribute("nwfaketop","true"),i.setAttribute("sandbox","allow-same-origin allow-scripts allow-forms allow-modals"),n.cb=function(e){i.src=a,e.appendChild(i)},n.cb1="yes",n.closed=function(){},n.responsive&&(n.width=n.height=null),kInteractive.openFrame(n),kInteractive.tinCan({verb:"opened",activity:"Widget: "+n.name}),setTimeout(function(){if(kInteractive.scorm){var e={};e.id=kInteractive.getScormId("widget",n.name),e.description="Opened popup widget: "+n.name,e.learnerResponses="Opened",e.type="other",e.timestamp=new Date,kInteractive.scorm.setInteractions([e])}kInteractive.events&&kInteractive.events.add({action:"popupWidgetOpened",param:n.name,elem:t,data:n})},800)}},resize:function(e){var t=kInteractive.readData(e);if(t&&"page"==t.mode&&"px"==t.widthUnit){var n=t.width,a=t.height,i=e.parentNode;if(i)if(n>i.offsetWidth){var r=i.offsetWidth/n,s=e.children.length-1;e.children[s].style.transform=e.children[s].style.webkitTransform=e.children[s].style.mozTransform="scale("+r+")",e.children[s].style.transformOrigin=e.children[s].style.webkitTransformOrigin=e.children[s].style.mozTransformOrigin="0 0",e.style.maxWidth=e.style.width,e.style.height=Math.round(a*r)+"px"}else{for(s=0;s<e.children.length;s++)e.children[s].style.transform=e.children[s].style.webkitTransform=e.children[s].style.mozTransform=e.children[s].style.transformOrigin=e.children[s].style.webkitTransformOrigin=e.children[s].style.mozTransformOrigin=null;e.style.maxWidth=null,e.style.height=a+"px"}}}},kInteractive.helpers.persister={instances:{},addInstance:function(e,t){kInteractive.helpers.persister.instances[e]=new kPersister(t)}};